{
  "name": "Easier",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        384,
        2736
      ],
      "id": "44db73e8-107b-4e5c-84b6-b394f2ffcae0",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -2128,
        1232
      ],
      "id": "92e9620b-8f06-4d9a-95ff-6a75801eee91",
      "name": "WhatsApp Trigger",
      "webhookId": "6ff86e2f-716f-4e9d-a215-e1d8ba5f9294",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "Ii58PWg9b3rPYKC2",
          "name": "Easier Auth WhatsApp"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -1904,
        1232
      ],
      "id": "c795ddbd-1d4c-4086-ae55-c3c25652e1a0",
      "name": "Buscar Usuario",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "=Hola {{ $('WhatsApp Trigger').first().json.contacts[0].profile.name }} üëã, no encontr√© tu registro en el sistema. Por favor, registra tu n√∫mero de tel√©fono en la app *Agenda Easier* para vincular tu cuenta y vuelve a enviar el mensaje para ayudarte.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -1232,
        1328
      ],
      "id": "3654a4f0-b80a-471c-a7db-b43c8b84d8da",
      "name": "Solicitar Vinculaci√≥n",
      "webhookId": "fae74b96-47ac-4a2a-832b-f98a98b0df8e",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1632,
        2512
      ],
      "id": "0b4e214c-18de-41e0-8904-aa35f31dc221",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente especializado en interpretar mensajes sobre organizaci√≥n acad√©mica (programas, materias, horarios, evaluaciones, tareas, ex√°menes, talleres, exposiciones, notas, etc.) y generar siempre un √∫nico objeto JSON v√°lido y estructurado.\nLa salida se procesar√° autom√°ticamente por n8n para trabajar con Firestore.\n\nüìå FORMATO OBLIGATORIO DE RESPUESTA\n\nDebes devolver solo:\n\n{\n  \"intenciones\": [ ... ]\n}\n\n\nNo incluyas texto adicional, explicaciones ni markdown.\n\nSi no detectas ninguna intenci√≥n v√°lida, retorna:\n\n{ \"intenciones\": [] }\n\n\nCada elemento dentro del array intenciones debe tener la forma:\n\n{\n  \"intencion\": \"...\",\n  \"detalle\": { ... },\n  \"userId\": \"<IDENTIFICADOR_DEL_USUARIO>\"\n}\n\n\nEl userId siempre debe ser:\n\n{{ $('UserContext').item.json.user_Id }}\n\n\nSi el nodo de usuario no devuelve ID, coloca \"\".\n\nüìå VARIABLES DISPONIBLES DEL ENTORNO\n\nMensaje del usuario:\n{{ $('WhatsApp Trigger').first().json.messages[0].text.body }}\n\nFecha actual:\n{{ $now }}\n\n\nüìå REGLAS GENERALES\n\nDevuelve siempre un JSON v√°lido con intenciones.\n\nNo inventes datos. Si un dato no aparece, deja \"\".\n\nFechas completas con el formato 2025-11-30 23:38:00.000 siempre. Si el usuario dice \"examen el 18\" (no dice mes), se seleccionar√° la fecha del mes correspondiente, en el caso de que el d√≠a seleccionado del mes actual no ha pasado, se selecciona ese (ejemplo: el usuario dice \"examen el 20\" y la fecha actual es \"19 de noviembre\", se selecciona el examen para el \"20/11/2025\"). Pero si el d√≠a seleccionado del mes actual ya pas√≥, se selecciona el mismo d√≠a pero del mes siguiente (ejemplo: el usuario dice \"examen el 20\" y la fecha actual es \"21 de noviembre\", se selecciona el examen para el \"20/12/2025\"). Si dice la semana que viene la fecha ser√° en 7 d√≠as despu√©s de la fecha actual.\n\nNormaliza materias a nombre capitalizado: ‚ÄúMatem√°ticas‚Äù, ‚ÄúHistoria‚Äù.\n\nNormaliza tipos de evaluaci√≥n, los tipos de evaluaciones existentes son:\n\n- Examen\n- Prueba Corta\n- Trabajo\n- Proyecto\n- Oral\n- Pr√°ctica\n- Otro\n- Sin Definir\n\nEl campo \"accion\" siempre debe existir.\n\nSi el usuario menciona varios eventos en un mensaje, genera varias intenciones.\n\nSi el usuario menciona expl√≠citamente un programa, incl√∫yelo en el campo \"programa\":\nEjemplos reconocibles:\n‚Äúen mi carrera de inform√°tica‚Äù, ‚Äúen el PNF de electr√≥nica‚Äù,\n‚Äúen ingenier√≠a industrial‚Äù, ‚Äúen administraci√≥n‚Äù, \"en mi curso de programaci√≥n web\".\n\nSi no menciona programa, deja \"programa\": \"\".\n\nLos estados de evaluaciones son:\n\n- Pendiente\n- Terminada\n- Calificada\n- No Terminada\n- Cancelada\n\nEl caso otro se usa cuando el mensaje tiene sentido pero no es acad√©mico.\n\nEl caso desconocido se usa cuando el mensaje no tiene sentido.\n\nElige el nombre que consideres adecuado para las evaluaciones si el usuario no lo proporciona\n\nEl color siempre ser√° igual a \"4294955366\"\n\nsi la evaluacion esta pendiente o el usuario no menciona que esta terminada ni dice ninguna nota, la nota SIEMPRE sera \"0\", a menos que el usuario diga una nota\n\nüéØ INTENCIONES DISPONIBLES Y ESTRUCTURA EXACTA\n1) ver_programas\n{\n  \"intencion\": \"ver_programas\",\n  \"detalle\": {\n    \"accion\": \"consultar\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n2) ver_materias\n{\n  \"intencion\": \"ver_materias\",\n  \"detalle\": {\n    \"accion\": \"consultar\",\n    \"programa\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n3) ver_horario\n{\n  \"intencion\": \"ver_horario\",\n  \"detalle\": {\n    \"accion\": \"consultar\",\n    \"programa\": \"\",\n    \"materia\": \"\",\n    \"dia\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n4) agregar_evaluaciones\n{\n  \"intencion\": \"agregar_evaluaciones\",\n  \"detalle\": {\n    \"accion\": \"agregar\",\n    \"nombre\": \"\",\n    \"color\": \"4294955366\",\n    \"programa\": \"\",\n    \"materia\": \"\",\n    \"fecha\": \"\",\n    \"tipo\": \"\",\n    \"estado\": \"Pendiente\",\n    \"descripcion\": \"\",\n    \"nota\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n5) modificar_evaluaciones\n{\n  \"intencion\": \"modificar_evaluaciones\",\n  \"detalle\": {\n    \"accion\": \"modificar\",\n    \"color\": \"4294955366\",\n    \"nombre\": \"\",\n    \"programa\": \"\",\n    \"materia\": \"\",\n    \"tipo\": \"\",\n    \"fecha\": \"\",\n    \"campo_modificado\": \"\",\n    \"nuevo_valor\": \"\",\n    \"nota\": \"\",\n    \"estado\": \"\"\n    \"descripcion\": \"\",\n  },\n  \"userId\": \"<ID>\"\n}\n\nSi se quieren modificar multiples campos, se generaran varias { \"intenciones\":  } correspondientes a los campos que quieran ser modificados, ejemplo se quiere modificar la fecha y el tipo, en la primera intencion el campo_modificado es fecha y en la segunda intencion es tipo\n\n6) eliminar_evaluaciones\n{\n  \"intencion\": \"eliminar_evaluaciones\",\n  \"detalle\": {\n    \"accion\": \"eliminar\",\n    \"color\": \"4294955366\",\n    \"nombre\": \"\",\n    \"programa\": \"\",\n    \"materia\": \"\",\n    \"fecha\": \"\",\n    \"tipo\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n7) ver_evaluaciones\n{\n  \"intencion\": \"ver_evaluaciones\",\n  \"detalle\": {\n    \"accion\": \"consultar\",\n    \"nombre\": \"\",\n    \"color\": \"4294955366\",\n    \"programa\": \"\",\n    \"materia\": \"\",\n    \"fecha\": \"\",\n    \"estado\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n8) ver_notas\n{\n  \"intencion\": \"ver_notas\",\n  \"detalle\": {\n    \"accion\": \"consultar\",\n    \"programa\": \"\",\n    \"materia\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n9) otro\n{\n  \"intencion\": \"otro\",\n  \"detalle\": {\n    \"descripcion\": \"\"\n  },\n  \"userId\": \"<ID>\"\n}\n\n10) desconocido\n{\n  \"intencion\": \"desconocido\",\n  \"detalle\": {},\n  \"userId\": \"<ID>\"\n}\n\n11) tutorial\n{\n  \"intencion\": \"tutorial\",\n  \"detalle\": {},\n  \"userId\": \"<ID>\"\n}\n\n12) premium\n{\n  \"intencion\": \"premium\",\n  \"detalle\": {},\n  \"userId\": \"<ID>\"\n}\n\nla intencion sra premium cuando el requerimiento del usuario tenga que ver con una actividad academica pero que no sea ninguna de las ya establecidas, es decir, si el usuario por ejemplo dice \"quiero agregar un programa\", \"quiero eliminar una materia\", como sabes, no te di la instruccion de que hacer si el usuario te dice eso, pero tiene que ver con la app, devolveras esta salida premium cuando sea as√≠, para evitar que des respuestas falsas como perfecto ya agregue tu programa cuando en realidad no es asi\n\nüß™ EJEMPLOS DETALLADOS (ACTUALIZADOS)\n1. El usuario menciona su programa expl√≠citamente\n\nMensaje:\n‚ÄúEn mi carrera de inform√°tica tengo un examen de matem√°ticas el 20.‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"agregar_evaluaciones\",\n      \"detalle\": {\n        \"accion\": \"agregar\",\n        \"nombre\": \"Corte 1\",\n        \"programa\": \"Inform√°tica\",\n        \"materia\": \"Matem√°ticas\",\n        \"fecha\": \"2025-12-20 15:38:00.000\",\n        \"tipo\": \"Ex√°men\",\n        \"estado\": \"Pendiente\",\n        \"descripcion\": \"\",\n        \"nota\": \"\"\n      },\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n2. Usuario quiere ver sus materias de un programa\n\nMensaje:\n‚ÄúMu√©strame las materias del PNF de administraci√≥n.‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"ver_materias\",\n      \"detalle\": {\n        \"accion\": \"consultar\",\n        \"programa\": \"Administraci√≥n\"\n      },\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n3. Usuario pide algo acad√©mico sin programa\n\nMensaje:\n‚ÄúTengo examen de historia el lunes.‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"agregar_evaluaciones\",\n      \"detalle\": {\n        \"accion\": \"agregar\",\n        \"programa\": \"\",\n        \"nombre\": \"Primera Evaluaci√≥n\",\n        \"materia\": \"Historia\",\n        \"fecha\": \"2025-12-01 23:25:00.000\",\n        \"tipo\": \"Ex√°men\",\n        \"estado\": \"Pendiente\",\n        \"descripcion\": \"\",\n        \"nota\": \"\"\n      },\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n4. Usuario pide ver horario de una materia\n\nMensaje:\n‚ÄúA qu√© hora tengo f√≠sica?‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"ver_horario\",\n      \"detalle\": {\n        \"accion\": \"consultar\",\n        \"programa\": \"\",\n        \"materia\": \"F√≠sica\",\n        \"dia\": \"\"\n      },\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n5. Usuario pide algo no acad√©mico\n\nMensaje:\n‚ÄúCu√©ntame un chiste.‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"otro\",\n      \"detalle\": {\n        \"descripcion\": \"peticion de chiste\"\n      },\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n6. Mensaje sin sentido\n\nMensaje:\n‚Äúqqw#21‚Äù\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"desconocido\",\n      \"detalle\": {},\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n7. Multiintenci√≥n\n\nMensaje:\n\"Hola, soy un nuevo usuario de Easier!, ¬øQu√© cosas puedo hacer?\"\n\no\n\n\"que puedo hacer\"\n\no\n\n\"para que sirves?\"\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"tutorial\",\n      \"detalle\": {},\n      \"userId\": \"<ID>\"\n    }\n  ]\n}\n\n8. Multiintenci√≥n\n\nMensaje:\n‚ÄúTengo examen de historia el lunes y exposici√≥n de biolog√≠a el martes.‚Äù\n\nSalida:\n\n{\n  \"intenciones\": [\n    {\n      \"intencion\": \"agregar_evaluaciones\",\n      \"detalle\": {\n        \"accion\": \"agregar\",\n        \"materia\": \"Historia\",\n        \"nombre\": \"Evaluaci√≥n 1\",\n        \"fecha\": \"2025-12-01 23:38:00.000\",\n        \"tipo\": \"Examen\",\n        \"estado\": \"Pendiente\",\n        \"descripcion\": \"\",\n        \"nota\": \"\"\n      },\n      \"userId\": \"...\"\n    },\n    {\n      \"intencion\": \"agregar_evaluaciones\",\n      \"detalle\": {\n        \"accion\": \"agregar\",\n        \"materia\": \"Biolog√≠a\",\n        \"nombre\": \"Evaluaci√≥n 3\",\n        \"fecha\": \"2025-12-02 23:38:00.000\",\n        \"tipo\": \"Oral\",\n        \"estado\": \"Pendiente\",\n        \"descripcion\": \"\",\n        \"nota\": \"\"\n      },\n      \"userId\": \"...\"\n    }\n  ]\n}",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        304,
        2512
      ],
      "id": "18c9d48a-ff1e-4e4e-871f-92226b48b973",
      "name": "Agente Interpretador"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual dise√±ado para interpretar mensajes de estudiantes en una aplicaci√≥n de gesti√≥n acad√©mica.\n\nTu tarea es analizar cualquier texto libre que el usuario ({{ $('WhatsApp Trigger').first().json.contacts[0].profile.name }}) escriba y proporcionarle una respuesta amigable.\n\nEl usuario puede escribir mensajes con errores, abreviaturas o expresiones coloquiales.\n\nEl mensaje del usuario es de tipo: {{ $json.descripcion }}, y es el siguiente: {{ $('WhatsApp Trigger').first().json.messages[0].text.body }}\n\nResp√≥ndele adecuadamente, siempre debes generar una respuesta acorde.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1552,
        2288
      ],
      "id": "0a1db882-27d3-4f73-b3f2-4ac1e1b1a9b1",
      "name": "Agente de respuesta libre"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "=He agregado tu evaluaci√≥n con la siguiente informaci√≥n:\n\nMateria: {{ $('set Fields Agregar Evaluaciones1').item.json.materia }}\nFecha: {{ $json.fecha }}\n",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        4752,
        -752
      ],
      "id": "b7bc6f94-ab51-40e2-9540-f3197ee50d35",
      "name": "Confirmaci√≥n adici√≥n",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "=No estoy seguro de lo que quieres decir üòÖ.\n\nPuedes pedirme cosas como ‚Äúmi horario‚Äù, ‚Äúagregar examen el 8‚Äù o ‚Äúver mis notas‚Äù.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1616,
        2688
      ],
      "id": "589e302a-77e9-4fac-ba46-5f6988b8d3ad",
      "name": "Mensaje desconocido",
      "webhookId": "b469ae1c-712c-47c1-b093-9458395a2f30",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1904,
        2384
      ],
      "id": "27a5e487-b762-472e-9e82-7f0fb269a55a",
      "name": "Mensaje",
      "webhookId": "3d64be0b-b4a4-4044-a71f-50ee53b38bfc",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// input: respuesta del nodo IA en $json (ej. $json.intenciones o $json.output parseado)\nlet raw = $json.intenciones || $json.intenciones_parsed || null;\n\n// Si el AI devolvi√≥ un string con JSON, parsearlo\nif (!raw && $json.output) {\n  try {\n    const cleaned = $json.output.replace(/```json|```/g, '').trim();\n    const parsed = JSON.parse(cleaned);\n    raw = parsed.intenciones || parsed.intenciones || [];\n  } catch (e) {\n    raw = [];\n  }\n}\n\nif (!Array.isArray(raw)) raw = [];\n\n// A√±adir userId del flujo (ej. del nodo Buscar Usuario o del WhatsApp Trigger)\nconst userPhone = $node[\"Buscar Usuario\"] ? ($node[\"Buscar Usuario\"].json.documents?.[0]?.fields?.telefono?.stringValue || $json.from || $json.contacts?.[0]?.wa_id) : ($json.from || $json.contacts?.[0]?.wa_id);\n\nconst items = raw.map(i => {\n  return {\n    json: {\n      intencion: i.intencion,\n      detalle: i.detalle || {},\n      userId: userPhone\n    }\n  };\n});\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        2512
      ],
      "id": "1d54f074-947e-4e12-8619-a424df0ea7e4",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $('set ProgramaID Directo4').first().json.programaId }}/materias/{{ $('Guardar materia seleccionada3').first().json.materiaSeleccionada }}/evaluaciones",
        "updateKey": "=id_Evaluacion",
        "columns": "tipo, fecha, nota, estado, descripcion, nombre"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        6576,
        -976
      ],
      "id": "b5e58170-d63f-402e-beba-1378854f270f",
      "name": "Modificar evaluaciones",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $('set ProgramaID Directo2').first().json.programaId }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "documentId": "=",
        "columns": "=fecha, color, tipo, estado, descripcion, nota, nombre"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4528,
        -752
      ],
      "id": "43c6c662-2ce7-4c50-a325-03a0fdc7b445",
      "name": "Agregar evaluaciones",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        880,
        2512
      ],
      "id": "c5b83b1c-2225-445c-9a8d-6d89e0b9c725",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        1104,
        2624
      ],
      "id": "e77335b6-cc5f-4e19-8980-395d9d535772"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "6a07498b-83e9-4e39-97dc-06e73a732283",
              "name": "nota",
              "value": "={{ $json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "47efde0a-2504-43e3-a247-5f010c9cd6a5",
              "name": "estado",
              "value": "={{ $json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "62007a81-46b9-4c7e-8d26-fe8b3c4c031e",
              "name": "campo_modificado",
              "value": "={{ $json.detalle.campo_modificado }}",
              "type": "string"
            },
            {
              "id": "9a5556c2-1987-4caa-83c2-0438967e9fc8",
              "name": "nuevo_valor",
              "value": "={{ $json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "11a0e2ee-d4bb-47ab-af33-89657954f82f",
              "name": "programa",
              "value": "={{ $json.detalle.programa }}",
              "type": "string"
            },
            {
              "id": "f37e7d74-3e0a-488e-b69a-3a60682aab91",
              "name": "nombre",
              "value": "={{ $json.detalle.nombre }}",
              "type": "string"
            },
            {
              "id": "8d14d910-1790-4759-b303-42e197eaf6e0",
              "name": "descripcion",
              "value": "={{ $json.detalle.descripcion }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        656
      ],
      "id": "b10b5601-3686-4f2c-8f4e-399315238077",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "ee02e763-f9b4-4428-ad34-801d8ecd6313",
              "name": "estado",
              "value": "={{ $json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "54f28b51-122a-45ed-9921-f12ddef0d6e5",
              "name": "descripcion",
              "value": "={{ $json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "c8ab6bb5-17dd-413e-8d57-c660aa9f09e7",
              "name": "nota",
              "value": "={{ $json.detalle.nota }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1328,
        2384
      ],
      "id": "19b9b0cb-ab87-4885-83b3-bbfea7db6820",
      "name": "Edit Fields9"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "ee02e763-f9b4-4428-ad34-801d8ecd6313",
              "name": "estado",
              "value": "={{ $json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "54f28b51-122a-45ed-9921-f12ddef0d6e5",
              "name": "descripcion",
              "value": "={{ $json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "c8ab6bb5-17dd-413e-8d57-c660aa9f09e7",
              "name": "nota",
              "value": "={{ $json.detalle.nota }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1328,
        2688
      ],
      "id": "e7767ca1-76a0-4ac5-ab0e-a1a47c3be9f4",
      "name": "Edit Fields10"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Code in JavaScript').first().json.detalle.campo_modificado }}",
                    "rightValue": "descripcion",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bce252d-4499-4596-a8bf-2e1714476721"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "descripcion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe706b3d-bc0d-45dd-99b9-678207a2614f",
                    "leftValue": "={{ $('Code in JavaScript').first().json.detalle.campo_modificado }}",
                    "rightValue": "tipo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tipo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7ec47b2b-11c3-415c-9656-415828ff2fc6",
                    "leftValue": "={{ $('Code in JavaScript').first().json.detalle.campo_modificado }}",
                    "rightValue": "fecha",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fecha"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a3229ffb-2bfe-430b-b37f-8b7acf1a5278",
                    "leftValue": "={{ $('Code in JavaScript').first().json.detalle.campo_modificado }}",
                    "rightValue": "nota",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nota"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eae567a1-b5ed-427e-9bac-60d092da4afe",
                    "leftValue": "={{ $('Code in JavaScript').first().json.detalle.campo_modificado }}",
                    "rightValue": "estado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "estado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        6000,
        -1040
      ],
      "id": "d9164630-4a49-4ec2-a82b-512a2ae30480",
      "name": "Switch1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ab6f3d46-a60a-464c-93bd-6fd3ccf24bb0",
              "name": "user_Id",
              "value": "={{ $json.usuario._id }}",
              "type": "string"
            },
            {
              "id": "fcbe69d7-9800-4ced-a4a5-fd71c8b70f50",
              "name": "usuarioRegistrado",
              "value": "={{ $json.usuario }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1232,
        1136
      ],
      "id": "b795d1c8-d278-48f6-a091-a4a169ffe3fb",
      "name": "UserContext"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "528fbec6-7c78-42dc-a358-121f84dd8a15",
              "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -48,
        1312
      ],
      "id": "c99943a2-1d81-428c-b03a-d6eb41071376",
      "name": "¬øTiene pendingAction?"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas/{{ $json.programaId }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2704,
        -464
      ],
      "id": "95b76fdc-b24a-41e0-8d83-2d5f8338966b",
      "name": "Listar Materias",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $json.mensajeMaterias }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        4240,
        -368
      ],
      "id": "9428903c-08b6-4ae5-b09d-e1be5c1d063c",
      "name": "Send message8",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "3d9eb629-edf4-4eac-9945-52f58e6b50ae",
              "name": "pendingCamposEvaluacion",
              "value": "={{ $('set Fields Agregar Evaluaciones2').all() }}",
              "type": "array"
            },
            {
              "id": "fdf0c5a5-1143-4e18-b95f-4698ec96ae01",
              "name": "programaSeleccionado",
              "value": "={{ $('set ProgramaID Directo2').first().json.programaId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4528,
        -368
      ],
      "id": "e1b8074c-b861-42e5-9d6d-fe2cbe052b27",
      "name": "Edit Fields18"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction, programaSeleccionado, pendingCamposEvaluacion"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4752,
        -368
      ],
      "id": "e05b04e2-9e36-43e7-a159-23188d61b130",
      "name": "Actualizar Usuario6",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * 1. Obtener la salida del nodo \"Procesar Materias1\"\n */\nconst procesado = $node[\"Procesar Materias1\"].json;\n\nif (!procesado || !Array.isArray(procesado.materias)) {\n  throw new Error(\"Procesar Materias1 no devolvi√≥ una lista v√°lida de materias.\");\n}\n\nconst materiasRaw = procesado.materias;\n\n/**\n * 2. Construir la lista con √≠ndice, id y nombre\n */\nconst materias = materiasRaw.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n/**\n * 3. Construir mensaje para el usuario\n */\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n/**\n * 4. Retornar resultado\n */\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        -368
      ],
      "id": "15221a94-aa3f-4876-a8c6-9c3f250eb90b",
      "name": "Procesar la lista"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "64355ab5-06dc-4a6c-8c2b-613372932baf",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "agregar_evaluaciones",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Agregar Evaluaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b8d70ac8-1706-4ecf-8fa5-402fa5066322",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "modificar_evaluaciones",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Modificar Evaluaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bfb8cc5c-f36f-42e7-8085-3fc69d9f842e",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "eliminar_evaluaciones",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Eliminar Evaluaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cbd96056-39ec-431f-a532-e72ff8238659",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "ver_evaluaciones",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Evaluaciones"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "110e9930-82b8-493c-af78-16662e4643b7",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "ver_programas",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Programas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "32caf198-89c5-41bb-9ec7-5fde167a77ed",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "ver_materias",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Materias"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "ver_horario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c3dfe751-5ba0-4eba-bbb0-650dd4f44a1f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Horario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1d1d3d0b-1f88-4845-85bd-c319a960f7cb",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "ver_notas",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Notas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0e0b9340-8853-4f75-8b2b-28b462e8efae",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "otro",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Otro"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e7649c4f-a0cb-490c-9af9-74135093c1b4",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "desconocido",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Desconocido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1f2a6a0a-a51e-479f-abf7-d3e17e18b58e",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "tutorial",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Tutorial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e09f5ead-cdff-4332-96ed-7a9e4e5dc9b4",
                    "leftValue": "={{$json[\"intencion\"]}}",
                    "rightValue": "premium",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "premium"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1104,
        2144
      ],
      "id": "7dd0ef4c-8b7c-4a48-8230-b3350c998ee0",
      "name": "¬øQu√© requiere el usuario?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "elegirProgramaModificarEvaluacion",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8a4a7992-eee6-4086-bd9b-41c11c03edf1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Elegir Programa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "041f7f2a-9993-49ac-832d-a8643e30acd7",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "elegirEvaluacionModificar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Elegir Evaluacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b91a4691-f501-4d22-9477-f055b43f6ddd",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "confirmarAlgo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmar Algo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "072c11d1-4f2a-488b-a22f-db292164a173",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "verMaterias",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ver Materias"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c054ba7f-8bc6-46fa-9d1f-c9f2b620e45d",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "elegirProgramaAgregarEvaluacion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Elegir Programa para Agregar Evaluaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d7c19558-4af2-4d10-9b2a-b1db3ab965fe",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "elegirMateriaAgregarEvaluacion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Elegir Materia para Agregar Evaluacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fbded8aa-938e-4481-afcf-36462153aaee",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingAction }}",
                    "rightValue": "elegirEvaluacionEliminar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Elegir Evaluacion para Eliminar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        240,
        -1376
      ],
      "id": "82e717d1-ef7f-4c93-b9f5-43969532a280",
      "name": "Switch pendingAction"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3728,
        -464
      ],
      "id": "ffc66fb5-2966-4328-9201-17d34a2d1ec4",
      "name": "¬øCoincidencia de Materia?"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1616,
        1616
      ],
      "id": "89c3047c-8627-477b-b85c-07ae25002de0",
      "name": "Obtener programas",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual dise√±ado para interpretar mensajes de estudiantes en una aplicaci√≥n de gesti√≥n acad√©mica.\n\nTu tarea es analizar cualquier texto libre que el usuario ({{ $('WhatsApp Trigger').first().json.contacts[0].profile.name }}) escriba y proporcionarle una respuesta amigable.\n\nEl usuario est√° solicitando una lista de los programas que tiene actualmente registrados en la aplicaci√≥n.\n\nEl usuario tiene ({{ $json.count }}) programa/s registrado/s\n\nLos programas del usuario son los siguientes:\n\n{{ $json.programasTexto }}\n\nGenera una lista unicamente con los nombres de los programas, ignora los ids",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2128,
        1504
      ],
      "id": "a3cdaf72-97c4-4edc-abad-3e00210d4781",
      "name": "Agente de Programas"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $json.detalle.accion }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1328,
        1616
      ],
      "id": "8fc29327-b52c-4034-9db4-8c4623957dd7",
      "name": "set Ver Programas"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "={{ $json.mensajeMaterias }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3152,
        1904
      ],
      "id": "a4c066f4-cac5-42de-a7f7-8438b9d190e6",
      "name": "Confirmaci√≥n adici√≥n2",
      "webhookId": "f4ff36db-08d4-4f8f-97c0-0b23f081256e",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $('¬øQu√© requiere el usuario?').item.json.detalle.accion }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        1904
      ],
      "id": "a67e8acf-a653-4e28-b71b-5089ef5b2793",
      "name": "set Ver Materias"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas/{{ $('set ProgramaID Directo').item.json.programaId }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2704,
        1904
      ],
      "id": "0f0716aa-a873-4ac9-b6c5-99fa37fd7828",
      "name": "Obtener materias",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1328,
        2000
      ],
      "id": "df0a1994-610a-4e78-87b2-bbe85b9e9cec",
      "name": "Listar Programa2",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2928,
        2096
      ],
      "id": "18181825-2670-4142-9bd7-75a755bfc9b4",
      "name": "Actualizar Usuario9",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const p = $json.programas[0];\nreturn [{ json: { userId: $json.userId, programaId: p.id, detalle: $json.detalle } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        1904
      ],
      "id": "568dfac2-5adb-4734-85ee-2a6455cb00c2",
      "name": "set ProgramaID Directo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "db16421e-04d0-4a2b-8a6e-58ea539f8184",
              "leftValue": "={{ $json.count }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1904,
        2000
      ],
      "id": "97f9eb31-9b62-4844-b2fb-d7888d30f17e",
      "name": "¬øUn √∫nico programa?"
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst programas = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  programas.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { programas, count: programas.length, detalle: $json.detalle, userId: $json.userId } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        2000
      ],
      "id": "48a010ae-cf9f-4233-b78a-c7e0d304b6c5",
      "name": "Procesar Programas"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        2480,
        1616
      ],
      "id": "dd46d7a8-7fe8-4b67-ab2e-4a9d6686faee",
      "name": "Mensaje Lista de Programas",
      "webhookId": "f4ff36db-08d4-4f8f-97c0-0b23f081256e",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Capturar salida del nodo \"Procesar Programas\"\nconst procesado = $node[\"Procesar Programas\"].json;\n\n// Obtener lista de programas\nconst programas = procesado.programas || [];\n\n// Construir mensaje\nlet mensaje = \"Elige el programa correspondiente:\\n\\n\";\n\nfor (const p of programas) {\n  mensaje += `${p.index}. ${p.nombre}\\n`;\n}\n\n// Devolver todo lo que necesitamos\nreturn [\n  {\n    json: {\n      mensajeProgramas: mensaje,\n      programas,\n      count: programas.length,\n      userId: procesado.userId,\n      detalle: procesado.detalle\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        2096
      ],
      "id": "3568509b-9955-4de6-a2d4-4b8bd39cf20c",
      "name": "Preparar Lista de Programas"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $items(\"WhatsApp Trigger\")[0].json.contacts[0].wa_id }}",
        "textBody": "={{ $json.mensajeProgramas }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        2480,
        2096
      ],
      "id": "61d92973-bf4d-4879-92cc-dc370e04dfd7",
      "name": "Mensaje Selecci√≥n de Programas",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "verMaterias",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Preparar Lista de Programas').first().json.programas) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $items(\"UserContext\")[0].json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2704,
        2096
      ],
      "id": "a0312198-11a5-4269-a5e9-28bee9ab9aa4",
      "name": "set pendingAction"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2432,
        -1472
      ],
      "id": "475f1a99-3ffc-41ae-b99f-f701bf12e247",
      "name": "Google Gemini Chat Model4",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas/{{ $('set Programa ID1').item.json.programaSeleccionado }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1776,
        -1600
      ],
      "id": "6101fef9-74ad-4e3b-839b-0c20de54e160",
      "name": "Obtener materias1",
      "alwaysOutputData": false,
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f81f8491-c15b-457d-bc1d-bd366269d22a",
              "name": "materiasListText",
              "value": "={{$items().map((item, i) => `${i+1}. ${item.json.nombre} = Aula: (${item.json.aula}) Descripci√≥n:(${item.json.descripcion}) Docente:(${item.json.profesor})`).join(\"\\n\")}}",
              "type": "string"
            },
            {
              "id": "2e4fbf0c-8530-4d80-840e-1ce529e6d7f5",
              "name": "materiasCount",
              "value": "={{$items().length}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2064,
        -1600
      ],
      "id": "041b850e-de8a-400e-bdb3-6fa228d593bd",
      "name": "set Lista Materias1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual dise√±ado para interpretar mensajes de estudiantes en una aplicaci√≥n de gesti√≥n acad√©mica.\n\nTu tarea es analizar cualquier texto libre que el usuario ({{ $('WhatsApp Trigger').item.json.contacts[0].profile.name }}) escriba y proporcionarle una respuesta amigable.\n\nEl usuario est√° solicitando una lista de las materias que tiene actualmente registradas en la aplicaci√≥n.\n\nEl usuario tiene ({{$json.materiasCount}}) materia/s registrada/s\n\nLas materias del usuario son los siguientes:\n\n{{$json.materiasListText}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2352,
        -1696
      ],
      "id": "b0535d43-8a71-4f06-8e66-f2a1d6b02d46",
      "name": "Agente de Materias1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "598e934c-3b32-41a9-8787-a280511ea351",
              "name": "programaSeleccionado",
              "value": "",
              "type": "string"
            },
            {
              "id": "5c26ee8e-98dd-4eb6-a7bf-8206fb718276",
              "name": "idUsuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2704,
        -1600
      ],
      "id": "073f9f99-9517-4453-9393-0f4787268ad0",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "idUsuario",
        "columns": "programaSeleccionado"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2928,
        -1600
      ],
      "id": "576841e8-ec70-42ad-a500-83e7366ba04e",
      "name": "Actualizar Usuario2",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec604c78-49c8-41a9-b7d2-9866e3d145e0",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "58766d33-4664-45ae-954a-c410292dadb2",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": "={{ JSON.parse($('Code in JavaScript22').item.json.usuario.pendingData).length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        752,
        -1504
      ],
      "id": "33139d2a-693b-4558-83e9-826156e48d00",
      "name": "¬øEs un programa v√°lido?1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e44eb214-6607-4ebc-bd2b-341a06cdd0e2",
              "name": "userChoicePrograma",
              "value": "={{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        528,
        -1504
      ],
      "id": "3a2aca89-fe2d-4e3e-9c08-23af060d01ce",
      "name": "set ChoicePrograma1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener userChoicePrograma (n√∫mero enviado por el usuario)\nconst index = parseInt($json.userChoicePrograma, 10) - 1;\n\n// 2. Obtener el usuario desde \"Buscar Usuario\"\nconst usuario = $node[\"Buscar Usuario\"].json;\n\n// Si no existe, romper con error claro\nif (!usuario) {\n  throw new Error(\"Buscar Usuario no devolvi√≥ un usuario.\");\n}\n\n// 3. Convertir pendingData STRING -> array\nlet programasLista;\ntry {\n  programasLista = JSON.parse(usuario.pendingData);\n} catch (e) {\n  throw new Error(\"Error al parsear pendingData: \" + e.message);\n}\n\n// Validar que sea un array\nif (!Array.isArray(programasLista)) {\n  throw new Error(\"pendingData no es un array.\");\n}\n\n// 4. Obtener el programa correspondiente\nconst programa = programasLista[index];\n\n// Validar √≠ndice\nif (!programa) {\n  throw new Error(`No existe un programa para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el programa\nreturn [\n  {\n    json: programa\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        -1600
      ],
      "id": "464e2451-0f6e-419e-8c4e-72bb7407eb15",
      "name": "Seleccionar Programa1"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "=id_usuario",
        "columns": "=programaSeleccionado, pendingAction, pendingData"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1488,
        -1600
      ],
      "id": "910f80d8-cebc-4cbe-957c-379342b4dba8",
      "name": "Actualizar Usuario3",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "32cd6a95-f430-4cc2-90a4-5a63de7983cd",
              "name": "programaSeleccionado",
              "value": "={{ $json.id.split('/').pop() }}",
              "type": "string"
            },
            {
              "id": "c3d2813c-7159-42ee-b3b8-69b6227b4bc9",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "513f1c47-869d-4da2-9008-efc15ad31a19",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "b9e0c805-8337-4b55-af4d-21fea0e18f8d",
              "name": "id_usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        -1600
      ],
      "id": "68a61b34-4d0a-4ea6-b493-5a7eabb12f2b",
      "name": "set Programa ID1"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "Ese n√∫mero no corresponde a ning√∫n programa, intenta de nuevo",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        976,
        -1408
      ],
      "id": "41e9c431-67a8-425a-bc0b-2a248a6dddb8",
      "name": "Send message9",
      "webhookId": "8bdff892-dd05-4a1d-9c89-c6904e5bdef2",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const programas = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre =\n    (doc.nombre && doc.nombre.stringValue)\n      ? doc.nombre.stringValue\n      : doc.nombre || doc.displayName || \"\";\n  programas.push({ index: i + 1, id, nombre });\n}\n\n// Crear versi√≥n de texto legible para la IA\nconst programasTexto = programas\n  .map(p => `${p.index}. ${p.nombre}`)\n  .join(\"\\n\");\n\nreturn [\n  {\n    json: {\n      programas,\n      programasTexto,   \n      count: programas.length,\n      detalle: $json.detalle,\n      userId: $json.userId\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        1616
      ],
      "id": "67f106c7-4ad2-4d83-967b-1178eccff300",
      "name": "Procesar Programas2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2208,
        1728
      ],
      "id": "f719f789-52c2-480d-88d5-02b430b60108",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1488,
        -336
      ],
      "id": "d768620a-4265-4c55-9082-5e4eca9df6b3",
      "name": "Listar Programa3",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction, materiaSeleccionada, pendingCamposEvaluacion"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3952,
        128
      ],
      "id": "c7652c81-b7a5-4865-b19e-b3cc83af1683",
      "name": "Actualizar Usuario10",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const p = $json.programas[0];\nreturn [{ json: { userId: $json.userId, programaId: p.id, detalle: $json.detalle } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        -464
      ],
      "id": "fd7ea814-ac77-4857-98d5-6e088d9e7553",
      "name": "set ProgramaID Directo2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "db16421e-04d0-4a2b-8a6e-58ea539f8184",
              "leftValue": "={{ $json.count }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2064,
        -336
      ],
      "id": "7c0efdf3-7388-4fbc-bc73-65c1223f1f34",
      "name": "¬øUn √∫nico programa?2"
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst programas = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  programas.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { programas, count: programas.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        -336
      ],
      "id": "3dd8e042-cb2c-491c-8688-f139f4a1a61e",
      "name": "Procesar Programas3"
    },
    {
      "parameters": {
        "jsCode": "// Capturar salida del nodo \"Procesar Programas\"\nconst procesado = $node[\"Procesar Programas3\"].json;\n\n// Obtener lista de programas\nconst programas = procesado.programas || [];\n\n// Construir mensaje\nlet mensaje = \"Elige el programa correspondiente:\\n\\n\";\n\nfor (const p of programas) {\n  mensaje += `${p.index}. ${p.nombre}\\n`;\n}\n\n// Devolver todo lo que necesitamos\nreturn [\n  {\n    json: {\n      mensajeProgramas: mensaje,\n      programas,\n      count: programas.length,\n      userId: procesado.userId,\n      detalle: procesado.detalle\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3216,
        128
      ],
      "id": "01f32505-6c03-4e05-9cf0-ded2cc2a7066",
      "name": "Preparar Lista de Programas1"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $items(\"WhatsApp Trigger\")[0].json.contacts[0].wa_id }}",
        "textBody": "={{ $json.mensajeProgramas }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3504,
        128
      ],
      "id": "73061cb8-1803-4641-8910-694d8887edae",
      "name": "Mensaje Selecci√≥n de Programas1",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec604c78-49c8-41a9-b7d2-9866e3d145e0",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "58766d33-4664-45ae-954a-c410292dadb2",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": "={{ JSON.parse($('Code in JavaScript22').item.json.usuario.pendingData).length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        752,
        -1120
      ],
      "id": "c32fc177-c726-4295-856c-a10939824cab",
      "name": "¬øEs un programa v√°lido?2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e44eb214-6607-4ebc-bd2b-341a06cdd0e2",
              "name": "userChoicePrograma",
              "value": "={{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        528,
        -1120
      ],
      "id": "ecfd3765-e5b7-4d45-8916-496838dcc46e",
      "name": "set ChoicePrograma2"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener userChoicePrograma (n√∫mero enviado por el usuario)\nconst index = parseInt($json.userChoicePrograma, 10) - 1;\n\n// 2. Obtener el usuario desde \"Buscar Usuario\"\nconst usuario = $node[\"Buscar Usuario\"].json;\n\n// Si no existe, romper con error claro\nif (!usuario) {\n  throw new Error(\"Buscar Usuario no devolvi√≥ un usuario.\");\n}\n\n// 3. Convertir pendingData STRING -> array\nlet programasLista;\ntry {\n  programasLista = JSON.parse(usuario.pendingData);\n} catch (e) {\n  throw new Error(\"Error al parsear pendingData: \" + e.message);\n}\n\n// Validar que sea un array\nif (!Array.isArray(programasLista)) {\n  throw new Error(\"pendingData no es un array.\");\n}\n\n// 4. Obtener el programa correspondiente\nconst programa = programasLista[index];\n\n// Validar √≠ndice\nif (!programa) {\n  throw new Error(`No existe un programa para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el programa\nreturn [\n  {\n    json: programa\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        -1216
      ],
      "id": "296c1c5d-71f7-4c19-84ee-9b566dfd112e",
      "name": "Seleccionar Programa2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "Ese n√∫mero no corresponde a ning√∫n programa, intenta de nuevo",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        976,
        -1024
      ],
      "id": "f574a663-d515-4bd1-ad50-2a9866cb58f9",
      "name": "Send message10",
      "webhookId": "8bdff892-dd05-4a1d-9c89-c6904e5bdef2",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "={{ $('Agente de Materias1').item.json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3216,
        -1600
      ],
      "id": "172405c8-a423-4524-a38f-c98c07ade4fe",
      "name": "Msj Lista Materias",
      "webhookId": "f4ff36db-08d4-4f8f-97c0-0b23f081256e",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de programas:\n{{ JSON.stringify($('Procesar Programas3').first().json.programas) }}\n\nEl usuario escribi√≥: \"{{ $('set Fields Agregar Evaluaciones2').first().json.programa }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con uno de los programas disponibles.\n\nReglas:\n\n1. Si el usuario escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o una variaci√≥n (‚Äúingenier√≠a info‚Äù, ‚Äúprogramacion‚Äù, etc.), busca el programa m√°s parecido mediante sentido com√∫n sem√°ntico.\n3. Si no hay coincidencia suficiente, devuelve ‚Äúnone‚Äù.\n\nLa salida debe ser SIEMPRE un JSON con este formato:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo devuelvas ning√∫n texto fuera de ese JSON.\nNo envuelvas el JSON en c√≥digo ni en comillas.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2352,
        32
      ],
      "id": "a25be713-40f1-44af-b999-5900d2ba01ca",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2432,
        256
      ],
      "id": "79dd5181-4cec-4920-a5ee-c9dfffe6cf2d",
      "name": "Google Gemini Chat Model6",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Programas3\"\nconst procesado = $node[\"Procesar Programas3\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Programas3 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de programas\nconst programas = procesado.programas;\n\nif (!Array.isArray(programas)) {\n  throw new Error(\"La salida de Procesar Programas3 no contiene un array 'programas'.\");\n}\n\n// 4. Seleccionar el programa por √≠ndice\nconst programa = programas[index];\n\nif (!programa) {\n  throw new Error(`No existe un programa para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el programa seleccionado\nreturn [\n  {\n    json: programa\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3216,
        -80
      ],
      "id": "9eef96b7-79b9-4bf1-9249-8df4b4937612",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f1e4d806-ff1d-4384-a868-85927dfe2983",
              "name": "programaSeleccionado",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3504,
        -80
      ],
      "id": "09a95920-423f-4839-a2f3-2c7d40586a66",
      "name": "Edit Fields8"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2704,
        32
      ],
      "id": "9cf07df3-e0ac-45c5-b476-f6767a0de735",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($items(\"Listar Materias\").map(i => i.json.nombre)) }}\n\nEl usuario escribi√≥: \"{{ $('set Fields Agregar Evaluaciones2').first().json.materia }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3152,
        -576
      ],
      "id": "8e33dfbf-bb72-4b03-99f4-758a0b460a17",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3504,
        -464
      ],
      "id": "97431ed0-3ce2-4e62-a693-e95237a93565",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3232,
        -352
      ],
      "id": "0bf016cd-fada-4ab1-905e-f05718205d18",
      "name": "Google Gemini Chat Model7",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        -464
      ],
      "id": "ddf713d8-ae69-40de-a4eb-83d5f2523e2e",
      "name": "Procesar Materias1"
    },
    {
      "parameters": {
        "jsCode": "// 1. √çndice enviado por IA\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener *todos* los items del nodo Listar Materias\nconst itemsMaterias = $items(\"Listar Materias\");\n\nif (!itemsMaterias || itemsMaterias.length === 0) {\n  throw new Error(\"Listar Materias no devolvi√≥ items.\");\n}\n\n// 3. Construir lista indexada\nconst materias = itemsMaterias.map((item, i) => ({\n  index: i + 1,\n  id: item.json._id,\n  nombre: item.json.nombre,\n  ...item.json\n}));\n\n// 4. Seleccionar materia por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar\nreturn [\n  { json: materia }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        -752
      ],
      "id": "429d6736-07d1-47af-a4b7-1280fbf77e2f",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=He agregado tu evaluaci√≥n con la siguiente informaci√≥n:\n\nMateria: {{ $('Code in JavaScript6').item.json.nombre }}\nFecha: {{ $json.fecha }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        5776,
        -1328
      ],
      "id": "d0f4ebf0-840b-4ff1-a871-50245ca22f71",
      "name": "Confirmaci√≥n adici√≥n1",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $('Edit Fields8').item.json.programaSeleccionado }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "documentId": "=",
        "columns": "=fecha, tipo, estado, descripcion, nota"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        5552,
        -1328
      ],
      "id": "44fa4308-c027-4287-baaf-7690f5a75d05",
      "name": "Agregar evaluaciones1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $json.programaSeleccionado }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3728,
        -80
      ],
      "id": "3946ed9e-7222-4df7-af23-0cca4b7fe22c",
      "name": "Listar Materias1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $json.mensajeMaterias }}\nSi no encuentras la materia, debes a√±adirla desde la aplicaci√≥n previamentea",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        5264,
        32
      ],
      "id": "f10e6f76-33bc-4e59-b47d-68981bfda289",
      "name": "Send message",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista1').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('Code in JavaScript1').item.json.id }}",
              "type": "string"
            },
            {
              "id": "ee828245-9f81-43e2-9a36-350cdda965a3",
              "name": "pendingCamposEvaluacion",
              "value": "={{ $('set Fields Agregar Evaluaciones2').all() }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5552,
        32
      ],
      "id": "0899db6e-a8f0-4dae-b7a2-1409a7bc8c32",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion, programaSeleccionado"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        5776,
        32
      ],
      "id": "19897e02-0ded-4a88-b67b-47f21e62b575",
      "name": "Actualizar Usuario7",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la salida del nodo \"Procesar Materias2\"\nconst procesado = $node[\"Procesar Materias2\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 2. Obtener la lista de materias\nconst materiasData = procesado.materias;\n\nif (!Array.isArray(materiasData)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 3. Construir la lista con √≠ndice\nconst materias = materiasData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n// 4. Construir mensaje para el usuario\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n// 5. Retornar la estructura esperada\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        32
      ],
      "id": "00c5741d-18e6-4095-800e-f087d5fcf512",
      "name": "Procesar la lista1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4752,
        -80
      ],
      "id": "cfb2a3ce-1d15-4388-9ccb-54093e49a71a",
      "name": "¬øCoincidencia de Materia?1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($('Procesar Materias2').first().json.materias) }}\n\nEl usuario escribi√≥: \"{{ $('set Fields Agregar Evaluaciones').first().json.materia }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        4176,
        -80
      ],
      "id": "40bc331d-040c-49f5-9991-46704e90d1bf",
      "name": "AI Agent2"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4528,
        -80
      ],
      "id": "5ad8e737-2774-4264-8a22-16ee39dd7fe6",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4256,
        160
      ],
      "id": "499faf6d-16ca-447d-9ba2-57e6a3ec772a",
      "name": "Google Gemini Chat Model8",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        -80
      ],
      "id": "c75c6f56-4811-4fba-9a79-fda55e34045a",
      "name": "Procesar Materias2"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Materias21\"\nconst procesado = $node[\"Procesar Materias2\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de materias\n// Puede estar como `materias` o `materias_lista` seg√∫n tu estructura\nconst materias = procesado.materias || procesado.materias_lista;\n\nif (!Array.isArray(materias)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 4. Seleccionar la materia por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        -1328
      ],
      "id": "94f45e19-05f4-4a6f-ba7e-72bf4e88cd2a",
      "name": "Code in JavaScript6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af1350-7e3c-4045-8943-bcdaf834c265",
              "name": "materiaSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "5dec62bf-3992-4669-9772-a8f9a813bd2f",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "52df62e5-c4bd-489a-8b5a-4b28ed76e663",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "15cd33d3-b855-45c1-9c76-7b85da0ed969",
              "name": "fecha",
              "value": "={{ $('set Fields Agregar Evaluaciones').first().json.fecha }}",
              "type": "string"
            },
            {
              "id": "db8c74dc-c89a-4d76-9485-1cbec08b9e13",
              "name": "tipo",
              "value": "={{ $('set Fields Agregar Evaluaciones').first().json.tipo }}",
              "type": "string"
            },
            {
              "id": "0bba0cf5-6c4e-4053-a452-30ea9156e98e",
              "name": "estado",
              "value": "={{ $('set Fields Agregar Evaluaciones').first().json.estado }}",
              "type": "string"
            },
            {
              "id": "5b3f3089-b6a6-4ee2-b796-02fa3be58069",
              "name": "descripcion",
              "value": "={{ $('set Fields Agregar Evaluaciones').first().json.descripcion }}",
              "type": "string"
            },
            {
              "id": "5d213867-3dcd-478b-b114-dabfb92453bc",
              "name": "nota",
              "value": "={{ $('set Fields Agregar Evaluaciones').first().json.nota }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5264,
        -1328
      ],
      "id": "527b1694-78be-4033-ae4d-78c69b4cddea",
      "name": "Guardar materia seleccionada1"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "Ese n√∫mero no corresponde a ninguna materia, intenta de nuevo",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        976,
        -640
      ],
      "id": "fed043f1-9bbe-47bb-8776-38fb188df311",
      "name": "Send message7",
      "webhookId": "8bdff892-dd05-4a1d-9c89-c6904e5bdef2",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "=He agregado tu evaluaci√≥n con la siguiente informaci√≥n:\n\nMateria: {{ $('Seleccionar Materia1').item.json.nombre }}\nFecha: {{ $json.fecha }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1776,
        -832
      ],
      "id": "b295ecf9-e855-4f0c-8a71-427b5a0c8713",
      "name": "Send message11",
      "webhookId": "6d0eb725-f705-457b-b459-ddca99b11ba0",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "32cd6a95-f430-4cc2-90a4-5a63de7983cd",
              "name": "materiaSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "068e8822-e315-4dc8-93d8-e7e6061eacaa",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            },
            {
              "id": "05db8e72-f85e-429e-9ce4-7f6eb06b2c85",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "785c1a19-cad5-44d5-a584-a2dfda737e41",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "c1283199-81f0-4ffc-8f5b-114289f72a9a",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b55b018e-758c-43da-a4c6-04ef1b3ac33b",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "955983af-96d4-401e-a2f9-911ea0969b75",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "1f293e6c-0792-4404-8010-3acf010d7f80",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "cd3eeedd-fefe-4d72-9f35-f83db9ecea3a",
              "name": "color",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.color }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        -832
      ],
      "id": "a5aee24a-3ef7-4603-aee2-42df9f1c0a11",
      "name": "set Materia ID1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e44eb214-6607-4ebc-bd2b-341a06cdd0e2",
              "name": "userChoiceMateria",
              "value": "={{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        528,
        -736
      ],
      "id": "e86a8795-eff5-42cf-a2a7-dcb454c78673",
      "name": "set ChoiceMateria1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec604c78-49c8-41a9-b7d2-9866e3d145e0",
              "leftValue": "={{ $json.userChoiceMateria.toNumber() }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "58766d33-4664-45ae-954a-c410292dadb2",
              "leftValue": "={{ $json.userChoiceMateria.toNumber() }}",
              "rightValue": "={{ JSON.parse($('Code in JavaScript22').item.json.usuario.pendingData).length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        752,
        -736
      ],
      "id": "306258fa-67ec-41d9-a4be-ca1fd53cba22",
      "name": "¬øEs una materia v√°lida?1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener userChoiceMateria (n√∫mero enviado por el usuario)\nconst index = parseInt($json.userChoiceMateria, 10) - 1;\n\n// 2. Obtener el usuario desde \"Buscar Usuario\"\nconst usuario = $node[\"Buscar Usuario\"].json;\n\n// Validar existencia del usuario\nif (!usuario) {\n  throw new Error(\"Buscar Usuario no devolvi√≥ un usuario.\");\n}\n\n// 3. Convertir pendingData STRING -> array\nlet materiasLista;\ntry {\n  materiasLista = JSON.parse(usuario.pendingData);\n} catch (e) {\n  throw new Error(\"Error al parsear pendingData para materias: \" + e.message);\n}\n\n// Validar que sea array\nif (!Array.isArray(materiasLista)) {\n  throw new Error(\"pendingData no es un array de materias.\");\n}\n\n// 4. Obtener la materia correspondiente\nconst materia = materiasLista[index];\n\n// Validar √≠ndice\nif (!materia) {\n  throw new Error(`No existe una materia para el n√∫mero ${index + 1}.`);\n}\n\n// 5. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        -832
      ],
      "id": "f20713ac-6ba3-4ec8-aa5e-e6e269028bc2",
      "name": "Seleccionar Materia1"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas/{{ $('Buscar Usuario').item.json.programaSeleccionado }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "columns": "=descripcion, estado, fecha, nota, tipo"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1488,
        -832
      ],
      "id": "6e20058f-518e-43ba-906c-dcab723b89a1",
      "name": "Crear Evaluaci√≥n",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "=id_Usuario",
        "columns": "=materiaSeleccionada, pendingAction, pendingData, pendingCamposEvaluacion, programaSeleccionado"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2416,
        -832
      ],
      "id": "729446e8-c1e9-428f-8717-4ba75277707f",
      "name": "Actualizar Usuario5",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e32bab5c-57f5-4d89-8e09-00807edaa72d",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "b2d79797-086b-4a30-95e4-eae07aed48cc",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "a0ad89d9-46fb-4fa6-9e61-798447857385",
              "name": "pendingCamposEvaluacion",
              "value": "",
              "type": "string"
            },
            {
              "id": "afb9585b-33fa-437f-a386-58345230d6e9",
              "name": "materiaSeleccionada",
              "value": "",
              "type": "string"
            },
            {
              "id": "d43fea2b-727a-4cc0-abcf-7868a52812bf",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            },
            {
              "id": "966f2fd0-4c17-4dcb-a297-e9177d72010b",
              "name": "programaSeleccionado",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2064,
        -832
      ],
      "id": "414a1bed-e20f-483c-b07e-c0374586a425",
      "name": "Edit Fields17"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $('set Programa ID2').first().json.programaSeleccionado }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "columns": "=descripcion, estado, fecha, nota, tipo"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3504,
        -1312
      ],
      "id": "a3c65fa3-a952-4317-b569-b4eba8e1d78a",
      "name": "Crear Evaluaci√≥n1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "32cd6a95-f430-4cc2-90a4-5a63de7983cd",
              "name": "programaSeleccionado",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "068e8822-e315-4dc8-93d8-e7e6061eacaa",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            },
            {
              "id": "05db8e72-f85e-429e-9ce4-7f6eb06b2c85",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "785c1a19-cad5-44d5-a584-a2dfda737e41",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "c1283199-81f0-4ffc-8f5b-114289f72a9a",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b55b018e-758c-43da-a4c6-04ef1b3ac33b",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "955983af-96d4-401e-a2f9-911ea0969b75",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "eaed7b88-05ad-4c0e-8b25-3b01d2064b90",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "4c627df1-91ce-4d1a-8e94-5967dc3a3ea1",
              "name": "color",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.color }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        -1216
      ],
      "id": "82295c71-f0a4-4aeb-91f0-484df3777b6e",
      "name": "set Programa ID2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "98d7d147-76b7-422b-bcfe-93d9bb3fbb9a",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2928,
        32
      ],
      "id": "3e110acf-1457-44e7-996c-3eb0ce87de78",
      "name": "¬øCoincide el programa?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirProgramaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Preparar Lista de Programas1').item.json.programas) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "materia",
              "value": "={{ $('set Fields Agregar Evaluaciones2').first().json.materia }}",
              "type": "string"
            },
            {
              "id": "ee828245-9f81-43e2-9a36-350cdda965a3",
              "name": "pendingCamposEvaluacion",
              "value": "={{ $('set Fields Agregar Evaluaciones2').all() }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3728,
        128
      ],
      "id": "fe5f747f-754e-4644-9b04-d95b66f93158",
      "name": "Edit Fields7"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=He agregado tu evaluaci√≥n con la siguiente informaci√≥n:\n\nMateria: {{ $('Code in JavaScript8').item.json.nombre }}\nFecha: {{ $json.fecha }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3728,
        -1312
      ],
      "id": "f8175928-1dd2-45a1-94cc-278155eb0900",
      "name": "Confirmaci√≥n adici√≥n3",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $json.programaSeleccionado }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1488,
        -1216
      ],
      "id": "a69f6f82-328e-41ef-a349-daba9c5e769b",
      "name": "Listar Materias2",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=No se consigui√≥ ninguna materia.\n\n{{ $json.mensajeMaterias }}\nSi no encuentras la materia, debes a√±adirla desde la aplicaci√≥n previamente",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3216,
        -912
      ],
      "id": "25ffc29b-e373-4d27-90b1-3413e92cbf30",
      "name": "Send message13",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista3').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('set Programa ID2').item.json.programaSeleccionado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3504,
        -912
      ],
      "id": "bbd2dc03-59a5-4ee6-bbbf-454b953c82fd",
      "name": "Edit Fields20"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3728,
        -912
      ],
      "id": "a951dbbc-bd1d-4f91-8c78-002752f5beec",
      "name": "Actualizar Usuario12",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la salida del nodo \"Procesar Materias2\"\nconst procesado = $node[\"Procesar Materias\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 2. Obtener la lista de materias\nconst materiasData = procesado.materias;\n\nif (!Array.isArray(materiasData)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 3. Construir la lista con √≠ndice\nconst materias = materiasData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n// 4. Construir mensaje para el usuario\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n// 5. Retornar la estructura esperada\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        -912
      ],
      "id": "bbf05164-2eb6-444b-a813-d06d7b7aa094",
      "name": "Procesar la lista3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2704,
        -1216
      ],
      "id": "0d25b78e-dd30-4ae5-8094-7d4646b212f5",
      "name": "¬øCoincidencia de Materia?2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($('Procesar Materias').first().json.materias) }}\n\nEl usuario escribi√≥: {{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2000,
        -1312
      ],
      "id": "b008999e-64fe-43e5-a5a0-a1a2218eeeb8",
      "name": "AI Agent3"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        -1216
      ],
      "id": "8efcfd7c-204d-4760-8203-6a410fe8c1be",
      "name": "Code in JavaScript7"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2080,
        -1088
      ],
      "id": "1326470d-70fd-430b-864d-65862e7949de",
      "name": "Google Gemini Chat Model9",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        -1216
      ],
      "id": "5d94422a-85c7-43ca-bf2e-5db3e73a4c6b",
      "name": "Procesar Materias"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Materias21\"\nconst procesado = $node[\"Procesar Materias\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de materias\n// Puede estar como `materias` o `materias_lista` seg√∫n tu estructura\nconst materias = procesado.materias || procesado.materias_lista;\n\nif (!Array.isArray(materias)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 4. Seleccionar la materia por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        -1312
      ],
      "id": "e9023530-7ff5-4190-ab1e-131897ab1cdc",
      "name": "Code in JavaScript8"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af1350-7e3c-4045-8943-bcdaf834c265",
              "name": "materiaSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "5dec62bf-3992-4669-9772-a8f9a813bd2f",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "52df62e5-c4bd-489a-8b5a-4b28ed76e663",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "15cd33d3-b855-45c1-9c76-7b85da0ed969",
              "name": "fecha",
              "value": "={{ $('set Programa ID2').first().json.fecha }}",
              "type": "string"
            },
            {
              "id": "db8c74dc-c89a-4d76-9485-1cbec08b9e13",
              "name": "tipo",
              "value": "={{ $('set Programa ID2').first().json.tipo }}",
              "type": "string"
            },
            {
              "id": "0bba0cf5-6c4e-4053-a452-30ea9156e98e",
              "name": "estado",
              "value": "={{ $('set Programa ID2').first().json.estado }}",
              "type": "string"
            },
            {
              "id": "5b3f3089-b6a6-4ee2-b796-02fa3be58069",
              "name": "descripcion",
              "value": "={{ $('set Programa ID2').first().json.descripcion }}",
              "type": "string"
            },
            {
              "id": "5d213867-3dcd-478b-b114-dabfb92453bc",
              "name": "nota",
              "value": "={{ $('set Programa ID2').first().json.nota }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3216,
        -1312
      ],
      "id": "696e6c96-4a9a-4938-ab5a-64cfe16a73e5",
      "name": "Guardar materia seleccionada2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "=",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "pendingCamposEvaluacion",
              "value": "=",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "=",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3952,
        -1312
      ],
      "id": "9c8df9cf-da89-4f46-97dc-b1f8c45ef3dc",
      "name": "Edit Fields21"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4240,
        -1312
      ],
      "id": "c80c6420-7618-4377-af4f-85330a811696",
      "name": "Actualizar Usuario13",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas/{{ $json.programaId }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2704,
        464
      ],
      "id": "106651d2-2f3e-4e13-922c-a6a19243a0f3",
      "name": "Listar Materias3",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3728,
        464
      ],
      "id": "57e17063-5690-40ec-b6af-03612eaaf68f",
      "name": "¬øCoincidencia de Materia?3"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').item.json.user_Id }}/programas",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        1488,
        656
      ],
      "id": "b6b3d38a-132c-43ce-bcb3-9369f29decc9",
      "name": "Listar Programa",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction, materiaSeleccionada, pendingCamposEvaluacion"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3952,
        1072
      ],
      "id": "72d1e72c-1a74-4fd9-a324-6be006cea8a3",
      "name": "Actualizar Usuario14",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const p = $json.programas[0];\nreturn [{ json: { userId: $json.userId, programaId: p.id, detalle: $json.detalle } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        464
      ],
      "id": "d76efe61-3719-41cc-b902-410277e082c3",
      "name": "set ProgramaID Directo4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "db16421e-04d0-4a2b-8a6e-58ea539f8184",
              "leftValue": "={{ $json.count }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2064,
        656
      ],
      "id": "1e6303aa-1153-4d20-a8f8-d0987ea0eff3",
      "name": "¬øUn √∫nico programa?3"
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst programas = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  programas.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { programas, count: programas.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        656
      ],
      "id": "eeb671dd-4930-4121-a137-e5fcafb84f11",
      "name": "Procesar Programas4"
    },
    {
      "parameters": {
        "jsCode": "// Capturar salida del nodo \"Procesar Programas\"\nconst procesado = $node[\"Procesar Programas4\"].json;\n\n// Obtener lista de programas\nconst programas = procesado.programas || [];\n\n// Construir mensaje\nlet mensaje = \"Elige el programa correspondiente:\\n\\n\";\n\nfor (const p of programas) {\n  mensaje += `${p.index}. ${p.nombre}\\n`;\n}\n\n// Devolver todo lo que necesitamos\nreturn [\n  {\n    json: {\n      mensajeProgramas: mensaje,\n      programas,\n      count: programas.length,\n      userId: procesado.userId,\n      detalle: procesado.detalle\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3216,
        1072
      ],
      "id": "a3a930bf-0785-4b9d-9831-60dd0ecb3f48",
      "name": "Preparar Lista de Programas2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $items(\"WhatsApp Trigger\")[0].json.contacts[0].wa_id }}",
        "textBody": "={{ $json.mensajeProgramas }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3504,
        1072
      ],
      "id": "0dbad4a7-ed0e-401d-b3b4-d8949ebb65de",
      "name": "Mensaje Selecci√≥n de Programas2",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de programas:\n{{ JSON.stringify($('Procesar Programas4').first().json.programas) }}\n\nEl usuario escribi√≥: \"{{ $('Edit Fields3').first().json.programa }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con uno de los programas disponibles.\n\nReglas:\n\n1. Si el usuario escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o una variaci√≥n (‚Äúingenier√≠a info‚Äù, ‚Äúprogramacion‚Äù, etc.), busca el programa m√°s parecido mediante sentido com√∫n sem√°ntico.\n3. Si no hay coincidencia suficiente, devuelve ‚Äúnone‚Äù.\n\nLa salida debe ser SIEMPRE un JSON con este formato:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo devuelvas ning√∫n texto fuera de ese JSON.\nNo envuelvas el JSON en c√≥digo ni en comillas.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2352,
        976
      ],
      "id": "0fae7ab6-777f-4339-8c93-f543bf7d32f5",
      "name": "AI Agent4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2432,
        1200
      ],
      "id": "dacead56-0a0f-4808-b6bc-4bd52290cc01",
      "name": "Google Gemini Chat Model10",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Programas3\"\nconst procesado = $node[\"Procesar Programas4\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Programas3 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de programas\nconst programas = procesado.programas;\n\nif (!Array.isArray(programas)) {\n  throw new Error(\"La salida de Procesar Programas3 no contiene un array 'programas'.\");\n}\n\n// 4. Seleccionar el programa por √≠ndice\nconst programa = programas[index];\n\nif (!programa) {\n  throw new Error(`No existe un programa para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el programa seleccionado\nreturn [\n  {\n    json: programa\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3216,
        880
      ],
      "id": "1b0fe801-7315-45e5-943e-2c92ed53c3db",
      "name": "Code in JavaScript9"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f1e4d806-ff1d-4384-a868-85927dfe2983",
              "name": "programaSeleccionado",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3504,
        880
      ],
      "id": "66a3e0dd-0b5f-4919-8b11-fd0a8a113f1e",
      "name": "Edit Fields22"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2704,
        976
      ],
      "id": "fa315d29-d646-41be-a074-c86eafa40a16",
      "name": "Code in JavaScript10"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($('Procesar Materias3').first().json.materias) }}\n\nEl usuario escribi√≥: \"{{ $('Edit Fields3').first().json.materia }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3152,
        464
      ],
      "id": "f830ad6d-1d48-4472-bc76-855ca08a4a6a",
      "name": "AI Agent5"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3504,
        464
      ],
      "id": "804886b5-af7f-4a91-98cb-b5d438dcfb8a",
      "name": "Code in JavaScript11"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3232,
        688
      ],
      "id": "597eb252-51cb-4715-b601-88e72be1753c",
      "name": "Google Gemini Chat Model11",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        464
      ],
      "id": "990ea908-1f99-410e-94a4-b55001e04c1f",
      "name": "Procesar Materias3"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Leer todos los √≠tems devueltos por el nodo\nconst materias = $items(\"Listar Materias3\", 0, 0).map(i => i.json);\n\n// Validaci√≥n\nif (!Array.isArray(materias) || materias.length === 0) {\n  throw new Error(\"Listar Materias3 no devolvi√≥ un array de materias.\");\n}\n\n// 3. Seleccionar por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 4. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        368
      ],
      "id": "08a6cf9c-7e8c-4a5d-adfd-2150aef2bc53",
      "name": "Code in JavaScript12"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af1350-7e3c-4045-8943-bcdaf834c265",
              "name": "materiaSeleccionada",
              "value": "={{ $json._id }}",
              "type": "string"
            },
            {
              "id": "5dec62bf-3992-4669-9772-a8f9a813bd2f",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "52df62e5-c4bd-489a-8b5a-4b28ed76e663",
              "name": "pendingData",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4240,
        368
      ],
      "id": "78d19a24-e659-4d08-ab04-9c8c780d2c7d",
      "name": "Guardar materia seleccionada3"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=He agregado tu evaluaci√≥n con la siguiente informaci√≥n:\n\nMateria: {{ $('Code in JavaScript14').item.json.nombre }}\nFecha: {{ $json.fecha }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        5776,
        784
      ],
      "id": "b29b586e-3a7c-40c5-9801-230158599c31",
      "name": "Confirmaci√≥n adici√≥n5",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $('Edit Fields22').item.json.programaSeleccionado }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "documentId": "=",
        "columns": "=fecha, tipo, estado, descripcion, nota, nombre"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        5552,
        784
      ],
      "id": "d62ca360-17b6-4951-936c-01967da34cba",
      "name": "Agregar evaluaciones3",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $json.programaSeleccionado }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3728,
        880
      ],
      "id": "8fcddef5-76ec-4b31-b609-d391e4d77152",
      "name": "Listar Materias4",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $json.mensajeMaterias }}\nSi no encuentras la materia, debes a√±adirla desde la aplicaci√≥n previamentea",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        5264,
        976
      ],
      "id": "872ed6a3-201a-4869-86f3-2ce473c42e38",
      "name": "Send message14",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista5').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('Code in JavaScript9').item.json.id }}",
              "type": "string"
            },
            {
              "id": "ee828245-9f81-43e2-9a36-350cdda965a3",
              "name": "pendingCamposEvaluacion",
              "value": "={{ $('Edit Fields3').all() }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5552,
        976
      ],
      "id": "5656b5e3-f1ed-4264-adb2-a45ae3e86f86",
      "name": "Edit Fields23"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        5776,
        976
      ],
      "id": "671ac112-dac3-483a-9e56-44c066c75a34",
      "name": "Actualizar Usuario15",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la salida del nodo \"Procesar Materias2\"\nconst procesado = $node[\"Procesar Materias4\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 2. Obtener la lista de materias\nconst materiasData = procesado.materias;\n\nif (!Array.isArray(materiasData)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 3. Construir la lista con √≠ndice\nconst materias = materiasData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n// 4. Construir mensaje para el usuario\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n// 5. Retornar la estructura esperada\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        976
      ],
      "id": "8346529c-7e8c-469d-a7c0-24c0b5e69827",
      "name": "Procesar la lista5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4752,
        880
      ],
      "id": "f959bcee-64a2-40ec-974b-b2ef3ec01a28",
      "name": "¬øCoincidencia de Materia?4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($('Procesar Materias4').first().json.materias) }}\n\nEl usuario escribi√≥: \"{{ $('Edit Fields3').first().json.materia }}\".\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        4176,
        880
      ],
      "id": "e1dd011b-2536-47bc-b63a-e0bc1d17cc4b",
      "name": "AI Agent6"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4528,
        880
      ],
      "id": "849a8189-1323-4291-b6af-5a7b5fa712db",
      "name": "Code in JavaScript13"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4256,
        1104
      ],
      "id": "d526a9d8-258f-457e-ad56-236576f4770b",
      "name": "Google Gemini Chat Model12",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        880
      ],
      "id": "73698d6d-9dd8-4e7a-8553-11ba56d4b95b",
      "name": "Procesar Materias4"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Materias21\"\nconst procesado = $node[\"Procesar Materias4\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de materias\n// Puede estar como `materias` o `materias_lista` seg√∫n tu estructura\nconst materias = procesado.materias || procesado.materias_lista;\n\nif (!Array.isArray(materias)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 4. Seleccionar la materia por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        784
      ],
      "id": "8ef51217-e1c0-49ac-b171-732e91dad4af",
      "name": "Code in JavaScript14"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af1350-7e3c-4045-8943-bcdaf834c265",
              "name": "materiaSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "5dec62bf-3992-4669-9772-a8f9a813bd2f",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "52df62e5-c4bd-489a-8b5a-4b28ed76e663",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "15cd33d3-b855-45c1-9c76-7b85da0ed969",
              "name": "fecha",
              "value": "={{ $('Edit Fields3').first().json.fecha }}",
              "type": "string"
            },
            {
              "id": "db8c74dc-c89a-4d76-9485-1cbec08b9e13",
              "name": "tipo",
              "value": "={{ $('Edit Fields3').first().json.tipo }}",
              "type": "string"
            },
            {
              "id": "0bba0cf5-6c4e-4053-a452-30ea9156e98e",
              "name": "estado",
              "value": "={{ $('Edit Fields3').first().json.estado }}",
              "type": "string"
            },
            {
              "id": "5b3f3089-b6a6-4ee2-b796-02fa3be58069",
              "name": "descripcion",
              "value": "={{ $('Edit Fields3').first().json.descripcion }}",
              "type": "string"
            },
            {
              "id": "5d213867-3dcd-478b-b114-dabfb92453bc",
              "name": "nota",
              "value": "={{ $('Edit Fields3').first().json.nota }}",
              "type": "string"
            },
            {
              "id": "4667f06e-aeca-4942-a98d-2378889da3f8",
              "name": "nombre",
              "value": "={{ $('Edit Fields3').first().json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5264,
        784
      ],
      "id": "7b40d7d5-af48-4cb4-a40c-00522f47c3e4",
      "name": "Guardar materia seleccionada4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "98d7d147-76b7-422b-bcfe-93d9bb3fbb9a",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2928,
        976
      ],
      "id": "62562ac3-3c3e-4ec2-94a3-e43b40cf7d9c",
      "name": "¬øCoincide el programa?1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirProgramaModificarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Preparar Lista de Programas2').item.json.programas) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "materiaSeleccionada",
              "value": "={{ $('Edit Fields3').first().json.materia }}",
              "type": "string"
            },
            {
              "id": "ee828245-9f81-43e2-9a36-350cdda965a3",
              "name": "pendingCamposEvaluacion",
              "value": "={{ $('Edit Fields3').all() }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3728,
        1072
      ],
      "id": "6f6ea679-d664-427d-9a4c-c4035e9f2c7e",
      "name": "Edit Fields24"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec604c78-49c8-41a9-b7d2-9866e3d145e0",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "58766d33-4664-45ae-954a-c410292dadb2",
              "leftValue": "={{ $json.userChoicePrograma }}",
              "rightValue": "={{ JSON.parse($('Code in JavaScript22').item.json.usuario.pendingData).length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1376,
        -3072
      ],
      "id": "8b298607-ebdc-4244-8558-a08e343e4bee",
      "name": "¬øEs un programa v√°lido?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e44eb214-6607-4ebc-bd2b-341a06cdd0e2",
              "name": "userChoicePrograma",
              "value": "={{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1152,
        -3072
      ],
      "id": "656c581b-8638-4774-a6e2-18565164dd99",
      "name": "set ChoicePrograma"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener userChoicePrograma (n√∫mero enviado por el usuario)\nconst index = parseInt($json.userChoicePrograma, 10) - 1;\n\n// 2. Obtener el usuario desde \"Buscar Usuario\"\nconst usuario = $node[\"Buscar Usuario\"].json;\n\n// Si no existe, romper con error claro\nif (!usuario) {\n  throw new Error(\"Buscar Usuario no devolvi√≥ un usuario.\");\n}\n\n// 3. Convertir pendingData STRING -> array\nlet programasLista;\ntry {\n  programasLista = JSON.parse(usuario.pendingData);\n} catch (e) {\n  throw new Error(\"Error al parsear pendingData: \" + e.message);\n}\n\n// Validar que sea un array\nif (!Array.isArray(programasLista)) {\n  throw new Error(\"pendingData no es un array.\");\n}\n\n// 4. Obtener el programa correspondiente\nconst programa = programasLista[index];\n\n// Validar √≠ndice\nif (!programa) {\n  throw new Error(`No existe un programa para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el programa\nreturn [\n  {\n    json: programa\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        -3168
      ],
      "id": "b2bc1fd6-e5da-4f58-b76c-9ff9d17d5c2a",
      "name": "Seleccionar Programa"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "Ese n√∫mero no corresponde a ning√∫n programa, intenta de nuevo",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1600,
        -2976
      ],
      "id": "386aa8df-c9a7-47bd-8fee-b233231cbabd",
      "name": "Send message15",
      "webhookId": "8bdff892-dd05-4a1d-9c89-c6904e5bdef2",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "32cd6a95-f430-4cc2-90a4-5a63de7983cd",
              "name": "programaSeleccionado",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "068e8822-e315-4dc8-93d8-e7e6061eacaa",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1824,
        -3168
      ],
      "id": "b9782c19-ff6b-498e-b497-02bf06fb3f49",
      "name": "set Programa ID"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=Se ha modificado la evaluaci√≥n.\n\n{{ $json.mensaje }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        6528,
        -3680
      ],
      "id": "0dd62da4-6228-4bcb-859e-f4c2ff7cb131",
      "name": "Confirmaci√≥n adici√≥n4",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $node[\"UserContext\"].json.user_Id }}/programas/{{ $json.programaSeleccionado }}/materias",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2112,
        -3168
      ],
      "id": "28f41064-5cad-4f2b-9bb3-4a2cc2f24c06",
      "name": "Listar Materias5",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=No se consigui√≥ ninguna materia.\n\n{{ $json.mensajeMaterias }}\nSi no encuentras la materia, debes a√±adirla desde la aplicaci√≥n previamente",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        3888,
        -2864
      ],
      "id": "ed149f82-15aa-4899-9222-5164fd0ba0dd",
      "name": "Send message16",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista6').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('set Programa ID').item.json.programaSeleccionado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4176,
        -2864
      ],
      "id": "d72fb2a4-5244-4d26-a5ce-fc0c68a4114e",
      "name": "Edit Fields25"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4400,
        -2864
      ],
      "id": "5e45eb70-74cf-4ef0-b0eb-cdcb778c9e32",
      "name": "Actualizar Usuario",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la salida del nodo \"Procesar Materias2\"\nconst procesado = $node[\"Procesar Materias5\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 2. Obtener la lista de materias\nconst materiasData = procesado.materias;\n\nif (!Array.isArray(materiasData)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 3. Construir la lista con √≠ndice\nconst materias = materiasData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n// 4. Construir mensaje para el usuario\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n// 5. Retornar la estructura esperada\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3600,
        -2864
      ],
      "id": "37f02ca8-0017-463a-8972-80fd9c47cee5",
      "name": "Procesar la lista6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e6948c32-7445-4786-bb43-6848df10c034",
              "leftValue": "={{ $json.resultado.toString() }}",
              "rightValue": "none",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3376,
        -3152
      ],
      "id": "ffadc371-ab5d-4b96-9287-14f0604f7b5c",
      "name": "¬øCoincidencia de Materia?5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tienes la siguiente lista de materias:\n{{ JSON.stringify($('Procesar Materias5').first().json.materias) }}\n\nEl usuario escribi√≥: {{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}.\n\nTu tarea es identificar si el texto del usuario coincide razonablemente con una materia de la lista.\n\nReglas:\n1. Si escribe un n√∫mero v√°lido (1, 2, 3‚Ä¶), devuelve EXACTAMENTE ese n√∫mero.\n2. Si escribe un nombre o variaci√≥n (‚Äúmate‚Äù, ‚Äúmatematica‚Äù, etc.), identifica la opci√≥n m√°s parecida.\n3. Si no hay ninguna coincidencia clara, devuelve ‚Äúnone‚Äù.\n\nLa respuesta debe ser SOLO este JSON:\n\n{\n  \"resultado\": <numero | \"none\">,\n  \"detalle\": {\n    \"textoUsuario\": \"<lo que escribi√≥ el usuario>\",\n    \"razon\": \"<explica por qu√© seleccionaste ese resultado o por qu√© no hubo coincidencia>\"\n  }\n}\n\nNo agregues texto adicional.\nNo uses bloques de c√≥digo.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2624,
        -3168
      ],
      "id": "eee7c02b-7700-42af-bb93-ec5a23689774",
      "name": "AI Agent7"
    },
    {
      "parameters": {
        "jsCode": "// El nodo de IA devuelve algo en items[0].json.output\n// Aqu√≠ nos aseguramos de que el contenido sea JSON limpio y v√°lido.\n\nlet raw = $json.output;\n\n// Si accidentalmente viniera con espacios, saltos o backticks los limpiamos:\nraw = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// Intentamos parsear el JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  throw new Error(\"La IA no devolvi√≥ un JSON v√°lido. Recibido: \" + raw);\n}\n\n// Validamos que exista \"resultado\"\nif (typeof parsed.resultado === \"undefined\") {\n  throw new Error('El JSON debe contener { \"resultado\": n√∫mero }');\n}\n\n// Devolvemos el objeto final que usar√° el resto del workflow\nreturn [\n  {\n    json: {\n      resultado: parsed.resultado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3088,
        -3152
      ],
      "id": "df7142c8-eb5d-441b-bf13-d26725d21ea3",
      "name": "Code in JavaScript15"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2704,
        -2944
      ],
      "id": "94693f41-5bb2-4fd1-8ff1-93b29f32f43a",
      "name": "Google Gemini Chat Model13",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items: resultado de Get Programas\nconst materias = [];\nfor (let i = 0; i < items.length; i++) {\n  const doc = items[i].json;\n  // obtener id del documento (name o _name)\n  const fullName = doc._name || doc.name || \"\";\n  const id = fullName ? fullName.split('/').pop() : (doc._id || \"\");\n  const nombre = (doc.nombre && doc.nombre.stringValue) ? doc.nombre.stringValue : doc.nombre || doc.displayName || \"\";\n  materias.push({ index: i+1, id, nombre });\n}\nreturn [{ json: { materias, count: materias.length, detalle: $json.detalle, userId: $json.userId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        -3168
      ],
      "id": "fb02c281-a4d2-4084-81d6-66b85163c5a0",
      "name": "Procesar Materias5"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener √≠ndice enviado por la IA (1 basado)\nconst index = parseInt($json.resultado, 10) - 1;\n\n// 2. Obtener la salida del nodo \"Procesar Materias21\"\nconst procesado = $node[\"Procesar Materias5\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 3. Obtener lista de materias\n// Puede estar como `materias` o `materias_lista` seg√∫n tu estructura\nconst materias = procesado.materias || procesado.materias_lista;\n\nif (!Array.isArray(materias)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 4. Seleccionar la materia por √≠ndice\nconst materia = materias[index];\n\nif (!materia) {\n  throw new Error(`No existe una materia para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar la materia seleccionada\nreturn [\n  {\n    json: materia\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3600,
        -3248
      ],
      "id": "f8aef6bc-3697-4cbb-a7b9-7640c9499743",
      "name": "Code in JavaScript16"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af1350-7e3c-4045-8943-bcdaf834c265",
              "name": "materiaSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3888,
        -3248
      ],
      "id": "a6219923-d971-44b5-9d06-d94cf128e715",
      "name": "Guardar materia seleccionada5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "=",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "pendingCamposEvaluacion",
              "value": "=",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "=",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6752,
        -3680
      ],
      "id": "84ea5812-4d48-4ae6-85e3-51e89e8b32f8",
      "name": "Edit Fields26"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        7040,
        -3680
      ],
      "id": "9ee7db9a-5e75-4bca-830b-9e52b6133e16",
      "name": "Actualizar Usuario16",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analiza cuidadosamente el mensaje del usuario y comp√°ralo con la lista de evaluaciones proporcionada.\nTu tarea es identificar qu√© evaluaci√≥n espec√≠fica quiere modificar el usuario.\n\nInstrucciones:\n\nRecibir√°s:\n\nevaluaciones[]: lista de evaluaciones dentro de la materia seleccionada.\nCada evaluaci√≥n puede contener:\n\nid\n\ntipo\n\nfecha\n\ndescripcion\n\nnombre (si aplica)\n\notros campos opcionales\n\ndatosUsuario: informaci√≥n que el usuario mencion√≥ (fecha, nombre, tipo, descripci√≥n o cualquier dato relevante).\n\nTu objetivo es determinar cu√°l evaluaci√≥n coincide mejor con lo descrito por el usuario.\nDebes comparar campo por campo:\n\nSi el usuario menciona una fecha, busca la evaluaci√≥n con esa fecha.\n\nSi menciona un tipo (‚Äúexamen‚Äù, ‚Äútaller‚Äù, ‚Äúprueba‚Äù), comp√°ralo con el campo tipo.\n\nSi menciona una descripci√≥n o nombre, compara con los campos correspondientes.\n\nSi menciona varios datos, la coincidencia debe basarse en la suma de coincidencias.\n\nPrioriza en este orden:\n\nCoincidencia exacta por fecha si el usuario dio una fecha. (Si no coincide la fecha autom√°ticamente encontrada: false)\n\nCoincidencia exacta por tipo si lo mencion√≥.\n\nCoincidencia por nombre o descripci√≥n.\n\nSi hay m√∫ltiples coincidencias, elige la m√°s espec√≠fica (mayor n√∫mero de campos coincidentes).\n\nSi ninguna coincide o hay varias evaluaciones con los mismos campos responde que no se encontr√≥ coincidencia clara.\n\nDevuelve SIEMPRE un JSON con esta estructura:\n\n{\n  \"seleccion\": {\n    \"encontrada\": true | false,\n    \"id\": \"id_de_la_evaluacion_o_null\",\n    \"razon\": \"Explica por qu√© elegiste esa evaluaci√≥n o por qu√© no hay coincidencias.\"\n  }\n}\n\nEjemplo de comportamiento esperado:\n\nSi el usuario dice:\n‚Äúquiero modificar la fecha de la evaluaci√≥n de f√≠sica, la que era el 11/12, y cambiarla al 12/12‚Äù\n\nY existe una evaluaci√≥n con fecha \"11/12\" dentro de la materia F√≠sica:\n\n‚Üí Debes devolver \"id\" de esa evaluaci√≥n.\n‚Üí Y \"encontrada\": true.\n\nLista de evaluaciones:\n\n{{ JSON.stringify($('Procesar lista de evaluaciones').first().json.evaluaciones) }}\n\nCampos proporcionados por el usuario:\n\n{{ JSON.stringify($('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json) }}\n\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        4848,
        -3248
      ],
      "id": "617fa790-4191-4b3c-8bda-eb8d28f04e94",
      "name": "AI Agent8"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4928,
        -3024
      ],
      "id": "6d7157d1-dda2-4b85-b234-d1f83d140760",
      "name": "Google Gemini Chat Model5",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $('set Programa ID').first().json.programaSeleccionado }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4176,
        -3248
      ],
      "id": "eeda27c0-919d-4bb8-b0dc-f6e12c6a5b02",
      "name": "Obtener evaluaciones",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $('set Programa ID').first().json.programaSeleccionado }}/materias/{{ $('Guardar materia seleccionada5').first().json.materiaSeleccionada }}/evaluaciones",
        "updateKey": "=id_Evaluacion",
        "columns": "=descripcion, nombre, estado, fecha, nota, tipo"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        6304,
        -3680
      ],
      "id": "12fc90b6-8ca2-441e-ae4c-fba925e1a1d4",
      "name": "Modificar",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Los GetAll en n8n entregan m√∫ltiples items en \"items\", no un objeto √∫nico.\nif (!items || items.length === 0) {\n  throw new Error(\"No hay evaluaciones disponibles.\");\n}\n\n// 2. Convertir items -> lista de evaluaciones\nconst evaluacionesData = items.map(item => item.json);\n\n// 3. Construir la lista con √≠ndice\nconst evaluaciones = evaluacionesData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item._id,\n    fecha: item.fecha,\n    descripcion: item.descripcion,\n    tipo: item.tipo\n  };\n});\n\n// 4. Retornar la lista procesada\nreturn [\n  {\n    json: {\n      evaluaciones: evaluaciones,\n      count: evaluaciones.length\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        -3248
      ],
      "id": "1fa1f5ee-0505-4103-b10f-d0a73d2cf182",
      "name": "Procesar lista de evaluaciones"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el output crudo de la IA\nconst raw = $json.output;\n\nif (!raw) {\n  throw new Error(\"La IA no devolvi√≥ ning√∫n output.\");\n}\n\n// 2. Limpiar triple backticks y `json`\nlet cleaned = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// 3. Parsear JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(cleaned);\n} catch (e) {\n  throw new Error(\"Error al interpretar el JSON devuelto por la IA: \" + e.message);\n}\n\n// 4. Validaciones\nif (!parsed.seleccion) {\n  throw new Error(\"La IA no devolvi√≥ el objeto 'seleccion'.\");\n}\n\nconst seleccion = parsed.seleccion;\n\nif (!seleccion.encontrada) {\n  // El flujo debe manejar que el usuario debe elegir manualmente\n  return [\n    {\n      json: {\n        encontrada: false,\n        razon: seleccion.razon || \"No se encontr√≥ coincidencia.\"\n      }\n    }\n  ];\n}\n\n// 5. Si se encontr√≥ una evaluaci√≥n, devolver el ID\nreturn [\n  {\n    json: {\n      encontrada: true,\n      idSeleccionado: seleccion.id,\n      razon: seleccion.razon\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5200,
        -3248
      ],
      "id": "bd248d18-d0ee-4346-b951-aa81b60371d3",
      "name": "Procesar Respuesta"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe706b3d-bc0d-45dd-99b9-678207a2614f",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "tipo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tipo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7ec47b2b-11c3-415c-9656-415828ff2fc6",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "fecha",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fecha"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a3229ffb-2bfe-430b-b37f-8b7acf1a5278",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nota",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nota"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eae567a1-b5ed-427e-9bac-60d092da4afe",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "estado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "estado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e9842e21-6ce7-42bb-b51a-f95c5b7ac3d7",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "descripcion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "descripcion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8a580cae-03fa-432a-95bf-1cc13cf15851",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nombre",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        5648,
        -3584
      ],
      "id": "09ac34b4-6680-440d-b12c-d05f5d89044f",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el resultado del nodo \"Obtener evaluaciones\"\nconst items = $items(\"Obtener evaluaciones\", 0, 0);\n\nif (!items || items.length === 0) {\n  return [\n    {\n      json: {\n        mensaje: \"No hay evaluaciones registradas para esta materia.\"\n      }\n    }\n  ];\n}\n\n// 2. Convertir cada evaluaci√≥n en un bloque de texto\nlet mensaje = \"Estas son las evaluaciones registradas:\\n\\n\";\n\nitems.forEach((item, index) => {\n  const ev = item.json;\n\n  const tipo = ev.tipo || ev.nombre || \"Sin tipo\";\n  const fecha = ev.fecha || \"Sin fecha\";\n  const descripcion = ev.descripcion || \"Sin descripci√≥n\";\n  const estado = ev.estado || \"Sin estado\";\n\n  mensaje += `${index + 1}. ${tipo}\\n`;\n  mensaje += `Fecha: ${fecha}\\n`;\n  mensaje += `Descripci√≥n: ${descripcion}\\n`;\n  mensaje += `Estado: ${estado}\\n\\n`;\n});\n\n// 3. Retornar mensaje\nreturn [\n  {\n    json: {\n      mensajeEvaluaciones: mensaje\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5744,
        -2816
      ],
      "id": "5d20c934-01a4-411e-a20b-a2d4d1d915e1",
      "name": "Code in JavaScript17"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $json.mensajeEvaluaciones }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        6032,
        -2816
      ],
      "id": "6bcf5270-8a1c-4fdb-8e25-b1c63eb3c579",
      "name": "Confirmaci√≥n adici√≥n6",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirEvaluacionModificar",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ $('Code in JavaScript18').item.json.pendingdata }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('set Programa ID').first().json.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "={{ $('Guardar materia seleccionada5').first().json.materiaSeleccionada }}",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6320,
        -2816
      ],
      "id": "f0437226-5089-422c-88f1-7a9583267f22",
      "name": "Edit Fields33"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        6544,
        -2816
      ],
      "id": "f130d1e1-bbd1-4f6c-a022-c3795767fe14",
      "name": "Actualizar Usuario17",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener TODOS los items del nodo \"Obtener evaluaciones\"\nconst firebaseItems = $items(\"Obtener evaluaciones\", 0);\n\n// Extraer el JSON de cada item (cada documento)\nconst evaluaciones = firebaseItems.map(i => i.json);\n\n// Construir el array con index\nconst indexed = evaluaciones.map((ev, i) => ({\n  index: i + 1,\n  id: ev._id,          // ID del documento\n  fecha: ev.fecha   // Campo nombre dentro del doc\n}));\n\n// Devolver como pendingdata tipo string JSON\nreturn [\n  {\n    json: {\n      pendingdata: JSON.stringify(indexed)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4624,
        -3248
      ],
      "id": "69ea101e-9162-4da7-b3b7-c6857803c027",
      "name": "Code in JavaScript18"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "Ese n√∫mero no corresponde a ninguna evaluaci√≥n, intenta de nuevo",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1408,
        -2112
      ],
      "id": "68588094-3b90-4bf0-866f-072c99b5d4a2",
      "name": "Send message17",
      "webhookId": "8bdff892-dd05-4a1d-9c89-c6904e5bdef2",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e44eb214-6607-4ebc-bd2b-341a06cdd0e2",
              "name": "userChoiceEvaluacion",
              "value": "={{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        960,
        -2224
      ],
      "id": "745fccc9-a0b2-4b82-9966-a6e4aba6c0f0",
      "name": "set ChoiceEvaluacion"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec604c78-49c8-41a9-b7d2-9866e3d145e0",
              "leftValue": "={{ $json.userChoiceEvaluacion }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "58766d33-4664-45ae-954a-c410292dadb2",
              "leftValue": "={{ $json.userChoiceEvaluacion }}",
              "rightValue": "={{ JSON.parse($('Code in JavaScript22').item.json.usuario.pendingData).length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1184,
        -2224
      ],
      "id": "31820489-16ea-4c0a-b466-b456b85cfd5f",
      "name": "¬øEs una evaluaci√≥n v√°lida?"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener userChoicePrograma (n√∫mero enviado por el usuario)\nconst index = parseInt($json.userChoiceEvaluacion, 10) - 1;\n\n// 2. Obtener el usuario desde \"Buscar Usuario\"\nconst usuario = $node[\"Buscar Usuario\"].json;\n\n// Si no existe, romper con error claro\nif (!usuario) {\n  throw new Error(\"Buscar Usuario no devolvi√≥ un usuario.\");\n}\n\n// 3. Convertir pendingData STRING -> array\nlet evaluacionLista;\ntry {\n  evaluacionLista = JSON.parse(usuario.pendingData);\n} catch (e) {\n  throw new Error(\"Error al parsear pendingData: \" + e.message);\n}\n\n// Validar que sea un array\nif (!Array.isArray(evaluacionLista)) {\n  throw new Error(\"pendingData no es un array.\");\n}\n\n// 4. Obtener el evaluacion correspondiente\nconst evaluacion = evaluacionLista[index];\n\n// Validar √≠ndice\nif (!evaluacion) {\n  throw new Error(`No existe un evaluacion para el √≠ndice ${index + 1}.`);\n}\n\n// 5. Retornar el evaluacion\nreturn [\n  {\n    json: evaluacion\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        -2416
      ],
      "id": "3d2683e2-1545-4fce-bf41-79908a54cb17",
      "name": "Seleccionar Evaluaci√≥n"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "32cd6a95-f430-4cc2-90a4-5a63de7983cd",
              "name": "evaluacionSeleccionada",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "068e8822-e315-4dc8-93d8-e7e6061eacaa",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').item.json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1632,
        -2416
      ],
      "id": "5d821b29-56c3-4f7b-afef-8c68822c6321",
      "name": "set Evaluaci√≥n ID"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=Se ha modificado la evaluaci√≥n.\n\n{{ $json.mensaje }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        2848,
        -2400
      ],
      "id": "85b49433-c8a1-4f0e-86b6-143213d08d59",
      "name": "Confirmaci√≥n adici√≥n7",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "=",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "pendingCamposEvaluacion",
              "value": "=",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "=",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3136,
        -2400
      ],
      "id": "359d46ba-1f02-4886-bcd2-c7e4bb631598",
      "name": "Edit Fields34"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        3360,
        -2400
      ],
      "id": "97c6b80a-8dcb-4df7-99b4-8d18d9fb4249",
      "name": "Actualizar Usuario18",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $json.id_Programa }}/materias/{{ $json.id_Materia }}/evaluaciones",
        "updateKey": "=id_Evaluacion",
        "columns": "=descripcion, nombre, estado, fecha, nota, tipo"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        2496,
        -2400
      ],
      "id": "233c105c-2390-4f82-b803-732835f9d093",
      "name": "Modificar1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "32854c64-2c8b-4783-99f6-56abbf033208",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "d8ea8363-6402-4531-a1dd-d06e84bbc76b",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -3872
      ],
      "id": "ddf832c9-7046-4bb4-8fb3-667bdcee46a8",
      "name": "Edit Fields38"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "c16df9bc-7055-40b4-92fe-196c379aca90",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -4064
      ],
      "id": "96b29bbe-69cc-4ba9-83b8-2d971de8689c",
      "name": "Edit Fields45"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "79327510-d067-4e20-9513-ecd6c8eab69c",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -3680
      ],
      "id": "54df7c2f-337d-4b59-aa53-ee470b93874f",
      "name": "Edit Fields46"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "a5806382-c736-40c4-a21b-499115143078",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -3504
      ],
      "id": "e09222a5-e939-4054-98b9-63344008ce2b",
      "name": "Edit Fields47"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "1a5b8e40-3aeb-4023-8a7a-53483dd95dfc",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -3312
      ],
      "id": "50028a10-530b-444c-8002-0e978763367f",
      "name": "Edit Fields48"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "32854c64-2c8b-4783-99f6-56abbf033208",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.tipo }}  Despu√©s: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6288,
        -1168
      ],
      "id": "3181d668-2299-4730-9a16-9675662a3329",
      "name": "Edit Fields39"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.descripcion }}  Despu√©s: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript').first().json.detalle.tipo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6288,
        -1360
      ],
      "id": "f0da1700-fbc6-4d5e-96c9-7e11a40eb78d",
      "name": "Edit Fields49"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.fecha }}  Despu√©s: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript').first().json.detalle.tipo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6288,
        -976
      ],
      "id": "697c8218-e28d-4b08-ae3f-4bb30dfb6440",
      "name": "Edit Fields50"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nota }}  Despu√©s: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript').first().json.detalle.tipo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6288,
        -672
      ],
      "id": "dabf878a-11b7-4717-83d6-f2c0df55c13b",
      "name": "Edit Fields51"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.estado }}  Despu√©s: {{ $('Code in JavaScript').first().json.detalle.campo_modificado }}: {{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript').first().json.detalle.tipo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6288,
        -480
      ],
      "id": "f044b6dd-f29c-46b4-b2ce-b576e087036e",
      "name": "Edit Fields52"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "019014db-f8c6-4ce7-8ea8-19f095552613",
              "leftValue": "={{ $json.encontrada }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5424,
        -3248
      ],
      "id": "66af8f43-213c-41f2-b077-c20193e61ce3",
      "name": "Coincidencia de evaluaci√≥n"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "559de2a6-3522-4f12-937f-31f7e9db262a",
              "name": "programa",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.programa }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "ee02e763-f9b4-4428-ad34-801d8ecd6313",
              "name": "estado",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "54f28b51-122a-45ed-9921-f12ddef0d6e5",
              "name": "descripcion",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "c8ab6bb5-17dd-413e-8d57-c660aa9f09e7",
              "name": "nota",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "ec4726a2-a463-41d1-9308-ed3c8f0040d4",
              "name": "=materiaSeleccionada",
              "value": "={{ $json._id }}",
              "type": "string"
            },
            {
              "id": "eb473ece-f717-4f43-9cc6-8f7143b5144e",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "864c681a-b871-4686-8bc9-88cfbbae6c64",
              "name": "pendingData",
              "value": "",
              "type": "string"
            },
            {
              "id": "a56593bd-19cf-4d5c-9595-248c08fe51ec",
              "name": "color",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.color }}",
              "type": "string"
            },
            {
              "id": "14409612-ef9b-4108-b8bf-8446196bbc56",
              "name": "nombre",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.nombre }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4240,
        -752
      ],
      "id": "78acacf6-0a29-481b-9a2f-1645b5971ffa",
      "name": "set Fields Agregar Evaluaciones1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "559de2a6-3522-4f12-937f-31f7e9db262a",
              "name": "programa",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.programa }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "ee02e763-f9b4-4428-ad34-801d8ecd6313",
              "name": "estado",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "54f28b51-122a-45ed-9921-f12ddef0d6e5",
              "name": "descripcion",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "c8ab6bb5-17dd-413e-8d57-c660aa9f09e7",
              "name": "nota",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.nota }}",
              "type": "string"
            },
            {
              "id": "492bd61f-1749-4f73-a5b9-d25ad62b8d34",
              "name": "=materia",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "259eba77-f0ca-45ed-bb5c-a14bfb219db8",
              "name": "nombre",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.nombre }}",
              "type": "string"
            },
            {
              "id": "3710c72b-7ab8-421b-a6c8-cdc53754764d",
              "name": "color",
              "value": "={{ $('¬øQu√© requiere el usuario?').first().json.detalle.color }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        -336
      ],
      "id": "1c658ee0-9fe1-4a62-a9df-497bd2ee65dc",
      "name": "set Fields Agregar Evaluaciones2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=Se ha modificado la evaluaci√≥n.\n\n{{ $json.mensaje }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        6800,
        -976
      ],
      "id": "063cb7ca-b0e9-4f44-9dad-396d473b1313",
      "name": "Confirmaci√≥n adici√≥n8",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "=No se consigui√≥ ninguna materia.\n\n{{ $json.mensajeMaterias }}\nSi no encuentras la materia, debes a√±adirla desde la aplicaci√≥n previamente",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        4240,
        576
      ],
      "id": "88f2b149-8698-40de-9e33-ecd57fa3629e",
      "name": "Send message18",
      "webhookId": "d0aa10f6-8c9b-4d6d-9f4c-4d1b3931e82c",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirMateriaAgregarEvaluacion",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ JSON.stringify($('Procesar la lista7').item.json.materiasLista) }}",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "id_usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('set Programa ID').item.json.programaSeleccionado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4528,
        576
      ],
      "id": "413ee474-418b-484c-bd6f-b7cc20909d54",
      "name": "Edit Fields28"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_usuario",
        "columns": "pendingData, pendingAction"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4752,
        576
      ],
      "id": "8382a0e3-8255-4dbb-9ea0-e8bf4d4798c3",
      "name": "Actualizar Usuario1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la salida del nodo \"Procesar Materias2\"\nconst procesado = $node[\"Procesar Materias5\"].json;\n\nif (!procesado) {\n  throw new Error(\"Procesar Materias2 no devolvi√≥ ning√∫n item.\");\n}\n\n// 2. Obtener la lista de materias\nconst materiasData = procesado.materias;\n\nif (!Array.isArray(materiasData)) {\n  throw new Error(\"La salida de Procesar Materias2 no contiene un array 'materias'.\");\n}\n\n// 3. Construir la lista con √≠ndice\nconst materias = materiasData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item.id,\n    nombre: item.nombre\n  };\n});\n\n// 4. Construir mensaje para el usuario\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}\\n`;\n});\n\n// 5. Retornar la estructura esperada\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        576
      ],
      "id": "3bcae677-a9c4-44f3-b7a2-fb9f1bddef62",
      "name": "Procesar la lista7"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "=",
              "type": "string"
            },
            {
              "id": "6fec1e92-43d5-4610-a0e0-1e2f7bbef8a2",
              "name": "pendingCamposEvaluacion",
              "value": "=",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "=",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7024,
        -976
      ],
      "id": "e5a45747-02c2-471a-a1c1-be0f9cd7aa91",
      "name": "Edit Fields29"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, pendingCamposEvaluacion, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        7248,
        -976
      ],
      "id": "12e51665-94d8-4c70-8c6e-1aff02095a95",
      "name": "Actualizar Usuario20",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analiza cuidadosamente el mensaje del usuario y comp√°ralo con la lista de evaluaciones proporcionada.\nTu tarea es identificar qu√© evaluaci√≥n espec√≠fica quiere modificar el usuario.\n\nInstrucciones:\n\nRecibir√°s:\n\nevaluaciones[]: lista de evaluaciones dentro de la materia seleccionada.\nCada evaluaci√≥n puede contener:\n\nid\n\ntipo\n\nfecha\n\ndescripcion\n\nnombre (si aplica)\n\notros campos opcionales\n\ndatosUsuario: informaci√≥n que el usuario mencion√≥ (fecha, nombre, tipo, descripci√≥n o cualquier dato relevante).\n\nTu objetivo es determinar cu√°l evaluaci√≥n coincide mejor con lo descrito por el usuario.\nDebes comparar campo por campo:\n\nSi el usuario menciona una fecha, busca la evaluaci√≥n con esa fecha.\n\nSi menciona un tipo (‚Äúexamen‚Äù, ‚Äútaller‚Äù, ‚Äúprueba‚Äù), comp√°ralo con el campo tipo.\n\nSi menciona una descripci√≥n o nombre, compara con los campos correspondientes.\n\nSi menciona varios datos, la coincidencia debe basarse en la suma de coincidencias.\n\nPrioriza en este orden:\n\nCoincidencia exacta por fecha si el usuario dio una fecha. (Si no coincide la fecha autom√°ticamente encontrada: false)\n\nCoincidencia exacta por tipo si lo mencion√≥.\n\nCoincidencia por nombre o descripci√≥n.\n\nSi hay m√∫ltiples coincidencias, elige la m√°s espec√≠fica (mayor n√∫mero de campos coincidentes).\n\nSi ninguna coincide o hay varias evaluaciones con los mismos campos responde que no se encontr√≥ coincidencia clara.\n\nDevuelve SIEMPRE un JSON con esta estructura:\n\n{\n  \"seleccion\": {\n    \"encontrada\": true | false,\n    \"id\": \"id_de_la_evaluacion_o_null\",\n    \"razon\": \"Explica por qu√© elegiste esa evaluaci√≥n o por qu√© no hay coincidencias.\"\n  }\n}\n\nEjemplo de comportamiento esperado:\n\nSi el usuario dice:\n‚Äúquiero modificar la fecha de la evaluaci√≥n de f√≠sica, la que era el 11/12, y cambiarla al 12/12‚Äù\n\nY existe una evaluaci√≥n con fecha \"11/12\" dentro de la materia F√≠sica:\n\n‚Üí Debes devolver \"id\" de esa evaluaci√≥n.\n‚Üí Y \"encontrada\": true.\n\nLista de evaluaciones:\n\n{{ JSON.stringify($('Procesar lista de evaluaciones1').first().json.evaluaciones) }}\n\nCampos proporcionados por el usuario:\n\n{{ JSON.stringify($('¬øQu√© requiere el usuario?').first().json.detalle) }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        5200,
        368
      ],
      "id": "a5cb8a92-5320-43bd-971a-8a83364002e4",
      "name": "AI Agent9"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        5280,
        592
      ],
      "id": "17a7d9c4-b6fe-4a50-b45e-d13f7b338da1",
      "name": "Google Gemini Chat Model14",
      "credentials": {
        "googlePalmApi": {
          "id": "4eDnATdhLyWNVpF7",
          "name": "Kevin Montilla"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "getAll",
        "projectId": "easier-agenda",
        "collection": "=usuarios/{{ $('UserContext').first().json.user_Id }}/programas/{{ $('set ProgramaID Directo4').first().json.programaId }}/materias/{{ $json.materiaSeleccionada }}/evaluaciones",
        "returnAll": true
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        4528,
        368
      ],
      "id": "4e74d815-2df4-4928-957a-7ef182e80968",
      "name": "Obtener evaluaciones1",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Los GetAll en n8n entregan m√∫ltiples items en \"items\", no un objeto √∫nico.\nif (!items || items.length === 0) {\n  throw new Error(\"No hay evaluaciones disponibles.\");\n}\n\n// 2. Convertir items -> lista de evaluaciones\nconst evaluacionesData = items.map(item => item.json);\n\n// 3. Construir la lista con √≠ndice\nconst evaluaciones = evaluacionesData.map((item, index) => {\n  return {\n    index: index + 1,\n    id: item._id,\n    fecha: item.fecha,\n    descripcion: item.descripcion,\n    tipo: item.tipo\n  };\n});\n\n// 4. Retornar la lista procesada\nreturn [\n  {\n    json: {\n      evaluaciones: evaluaciones,\n      count: evaluaciones.length\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        368
      ],
      "id": "ca79201b-cde7-4ed1-9008-c7c2936c2064",
      "name": "Procesar lista de evaluaciones1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el output crudo de la IA\nconst raw = $json.output;\n\nif (!raw) {\n  throw new Error(\"La IA no devolvi√≥ ning√∫n output.\");\n}\n\n// 2. Limpiar triple backticks y `json`\nlet cleaned = raw\n  .replace(/```json/gi, \"\")\n  .replace(/```/g, \"\")\n  .trim();\n\n// 3. Parsear JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(cleaned);\n} catch (e) {\n  throw new Error(\"Error al interpretar el JSON devuelto por la IA: \" + e.message);\n}\n\n// 4. Validaciones\nif (!parsed.seleccion) {\n  throw new Error(\"La IA no devolvi√≥ el objeto 'seleccion'.\");\n}\n\nconst seleccion = parsed.seleccion;\n\nif (!seleccion.encontrada) {\n  // El flujo debe manejar que el usuario debe elegir manualmente\n  return [\n    {\n      json: {\n        encontrada: false,\n        razon: seleccion.razon || \"No se encontr√≥ coincidencia.\"\n      }\n    }\n  ];\n}\n\n// 5. Si se encontr√≥ una evaluaci√≥n, devolver el ID\nreturn [\n  {\n    json: {\n      encontrada: true,\n      idSeleccionado: seleccion.id,\n      razon: seleccion.razon\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5552,
        368
      ],
      "id": "6cac0430-9c66-4721-bff0-605f7a86ff43",
      "name": "Procesar Respuesta1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el resultado del nodo \"Obtener evaluaciones\"\nconst items = $items(\"Obtener evaluaciones1\", 0, 0);\n\nif (!items || items.length === 0) {\n  return [\n    {\n      json: {\n        mensaje: \"No hay evaluaciones registradas para esta materia.\"\n      }\n    }\n  ];\n}\n\n// 2. Convertir cada evaluaci√≥n en un bloque de texto\nlet mensaje = \"Estas son las evaluaciones registradas:\\n\\n\";\n\nitems.forEach((item, index) => {\n  const ev = item.json;\n\n  const tipo = ev.tipo || ev.nombre || \"Sin tipo\";\n  const fecha = ev.fecha || \"Sin fecha\";\n  const descripcion = ev.descripcion || \"Sin descripci√≥n\";\n  const estado = ev.estado || \"Sin estado\";\n\n  mensaje += `${index + 1}. ${tipo}\\n`;\n  mensaje += `Fecha: ${fecha}\\n`;\n  mensaje += `Descripci√≥n: ${descripcion}\\n`;\n  mensaje += `Estado: ${estado}\\n\\n`;\n});\n\n// 3. Retornar mensaje\nreturn [\n  {\n    json: {\n      mensajeEvaluaciones: mensaje\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6000,
        784
      ],
      "id": "a9b972b2-9618-47e0-9969-6acd970501b5",
      "name": "Code in JavaScript20"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $json.mensajeEvaluaciones }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        6288,
        784
      ],
      "id": "a7d1795f-c0aa-4163-b3cd-42648b78e001",
      "name": "Confirmaci√≥n adici√≥n9",
      "webhookId": "276946d1-d549-46c1-ad0d-809ddedef281",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "elegirEvaluacionModificar",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "={{ $('Code in JavaScript21').item.json.pendingdata }}",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "={{ $('set Programa ID').first().json.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "={{ $('Guardar materia seleccionada').first().json.materiaSeleccionada }}",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6576,
        784
      ],
      "id": "f9faf78e-de09-405e-bde6-a803529fc742",
      "name": "Edit Fields35"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, programaSeleccionado, materiaSeleccionada"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        6800,
        784
      ],
      "id": "7676b4a1-7ebe-4394-80dd-4bf46a234c05",
      "name": "Actualizar Usuario21",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener TODOS los items del nodo \"Obtener evaluaciones\"\nconst firebaseItems = $items(\"Obtener evaluaciones1\", 0);\n\n// Extraer el JSON de cada item (cada documento)\nconst evaluaciones = firebaseItems.map(i => i.json);\n\n// Construir el array con index\nconst indexed = evaluaciones.map((ev, i) => ({\n  index: i + 1,\n  id: ev._id,          // ID del documento\n  fecha: ev.fecha   // Campo nombre dentro del doc\n}));\n\n// Devolver como pendingdata tipo string JSON\nreturn [\n  {\n    json: {\n      pendingdata: JSON.stringify(indexed)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        368
      ],
      "id": "614513cc-93cf-4a50-8677-f7b43deb946b",
      "name": "Code in JavaScript21"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "019014db-f8c6-4ce7-8ea8-19f095552613",
              "leftValue": "={{ $json.encontrada }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5776,
        368
      ],
      "id": "1184bbe8-4bf6-4cd9-a0a2-5a6ad52c0fd0",
      "name": "Coincidencia de evaluaci√≥n1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener TODAS las materias desde el nodo GetAll (ajusta el nombre)\nconst materiasRaw = $items(\"Obtener materias\", 0, 0).map(i => i.json);\n\n// Validaci√≥n\nif (!Array.isArray(materiasRaw) || materiasRaw.length === 0) {\n  throw new Error(\"El nodo Obtener materias no devolvi√≥ ninguna materia.\");\n}\n\n// 2. Convertir a estructura estandarizada\nconst materias = materiasRaw.map((m, idx) => {\n  return {\n    index: idx + 1,\n    id: m._id || m.id || null,\n    nombre: m.nombre || \"\",\n    aula: m.aula || null,\n    profesor: m.profesor || null\n  };\n});\n\n// 3. Crear mensaje enumerado\nlet mensaje = \"Elige la materia correspondiente:\\n\\n\";\n\nmaterias.forEach(m => {\n  mensaje += `${m.index}. ${m.nombre}`;\n  \n  // Agregar informaci√≥n opcional\n  const extras = [];\n  if (m.aula) extras.push(`Aula: ${m.aula}`);\n  if (m.profesor) extras.push(`Profesor: ${m.profesor}`);\n  \n  if (extras.length > 0) {\n    mensaje += ` (${extras.join(\", \")})`;\n  }\n\n  mensaje += \"\\n\";\n});\n\n// 4. Retorno final para usar aguas abajo (IA, WhatsApp, etc.)\nreturn [\n  {\n    json: {\n      materiasLista: materias,\n      mensajeMaterias: mensaje\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        1904
      ],
      "id": "edb46c4a-53d9-4742-a8ad-e0b7b3abe526",
      "name": "Code in JavaScript19"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el tel√©fono del usuario desde WhatsApp\nconst telefonoUsuario = $('WhatsApp Trigger').first().json.contacts[0].wa_id;\n\nif (!telefonoUsuario) {\n  throw new Error(\"No se pudo obtener el tel√©fono del usuario del mensaje de WhatsApp.\");\n}\n\n// 2. Obtener todos los usuarios devueltos por Firebase\nconst usuarios = $input.all().map(item => item.json);\n\nif (!usuarios.length) {\n  return [\n    {\n      json: {\n        encontrado: false,\n        telefonoUsuario,\n        usuario: null\n      }\n    }\n  ];\n}\n\n// 3. Buscar el usuario con coincidencia de tel√©fono\nconst usuarioEncontrado = usuarios.find(u => u.telefono === telefonoUsuario);\n\n// 4. Retornar resultado\nreturn [\n  {\n    json: {\n      encontrado: !!usuarioEncontrado,\n      telefonoUsuario,\n      usuario: usuarioEncontrado || null\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        1232
      ],
      "id": "0276998a-3a8c-46f7-abde-92096ff7f433",
      "name": "Code in JavaScript22"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a6f4425f-f7c6-456e-b4ce-12862a4c99f8",
              "leftValue": "={{ $json.encontrado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1456,
        1232
      ],
      "id": "a254fb68-f018-4f10-a932-2ef4a9c1b6ee",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
        "textBody": "=üì± ¬°Hola! Soy tu asistente acad√©mico por WhatsApp.\nEstoy aqu√≠ para ayudarte a manejar tu vida estudiantil de forma r√°pida y sin complicaciones.\nEsto es lo que puedo hacer por ti:\n\nüìò Ver tus materias y programas\n\nPuedo mostrarte todas tus materias registradas y el programa acad√©mico que est√°s usando.\n\nEjemplos:\n‚ÄúVer mis materias.‚Äù\n‚Äú¬øCu√°l es mi programa?‚Äù\n\n(Para agregar o cambiar materias/programas debes usar la app.)\n\nüïí Consultar tus horarios\n\nPuedo ense√±arte tus horarios semanales tal como los tienes configurados.\n\nEjemplos:\n‚ÄúMu√©strame mis horarios.‚Äù\n‚Äú¬øQu√© tengo los lunes?‚Äù\n\n(Los horarios solo se editan en la app.)\n\nüìù Agregar, consultar, modificar o eliminar evaluaciones\n\nAqu√≠ s√≠ tienes libertad total por WhatsApp.\nPuedes trabajar con tareas, ex√°menes, exposiciones, proyectos, etc.\n\nEjemplos:\n‚ÄúAgregar evaluaci√≥n de F√≠sica el martes.‚Äù\n‚Äú¬øQu√© evaluaciones tengo esta semana?‚Äù\n‚ÄúEditar la evaluaci√≥n de Matem√°tica del jueves.‚Äù\n‚ÄúEliminar la evaluaci√≥n de F√≠sica del martes.‚Äù\n\nImportante:\nSolo puedo crear evaluaciones de materias que ya existan.\nSi intentas agregar una evaluaci√≥n de una materia no registrada, te avisar√©.\n\nüóìÔ∏è Ver tu agenda\n\nPuedo mostrarte todo lo que tienes pendiente en diferentes rangos de tiempo.\n\nEjemplos:\n‚Äú¬øQu√© tengo hoy?‚Äù\n‚ÄúMu√©strame mis tareas.‚Äù\n‚ÄúVer mis evaluaciones del mes.‚Äù\n\nüîî Recordatorios inteligentes\n\nPuedo avisarte sobre tus evaluaciones seg√∫n las configuraciones que tengas.\nT√∫ solo me pides la informaci√≥n y yo te muestro lo que viene.\n\nüîê Datos personales\n\nTus datos personales ‚Äînombre, pa√≠s, g√©nero, cumplea√±os, entre otros‚Äî\nno pueden modificarse por WhatsApp para proteger tu cuenta.\nEstos cambios solo se hacen desde la app.\n\nSi quieres empezar, solo dime lo que necesitas.\nEstoy aqu√≠ para que estudiar sea m√°s f√°cil y menos ca√≥tico.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1616,
        2880
      ],
      "id": "b2a56528-8bcb-4cd4-a83f-975ab19f356f",
      "name": "Mensaje desconocido1",
      "webhookId": "b469ae1c-712c-47c1-b093-9458395a2f30",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2e52c5e-c052-4904-a650-762add34a9be",
              "name": "accion",
              "value": "={{ $json.detalle.accion }}",
              "type": "string"
            },
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "materia",
              "value": "={{ $json.detalle.materia }}",
              "type": "string"
            },
            {
              "id": "cc3aa8af-6be5-4f84-9d1e-c2791a60f2af",
              "name": "fecha",
              "value": "={{ $json.detalle.fecha }}",
              "type": "string"
            },
            {
              "id": "a05cc3cf-aadc-415d-a4a4-eb07cc608698",
              "name": "tipo",
              "value": "={{ $json.detalle.tipo }}",
              "type": "string"
            },
            {
              "id": "ee02e763-f9b4-4428-ad34-801d8ecd6313",
              "name": "estado",
              "value": "={{ $json.detalle.estado }}",
              "type": "string"
            },
            {
              "id": "54f28b51-122a-45ed-9921-f12ddef0d6e5",
              "name": "descripcion",
              "value": "={{ $json.detalle.descripcion }}",
              "type": "string"
            },
            {
              "id": "c8ab6bb5-17dd-413e-8d57-c660aa9f09e7",
              "name": "nota",
              "value": "={{ $json.detalle.nota }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1328,
        2880
      ],
      "id": "3230a86b-0a84-4797-a940-d0308b1c63fb",
      "name": "Edit Fields11"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "=Lo siento, esa opci√≥n est√° reservada para usuarios Premium.\nSi deseas activarla y acceder a m√°s funciones avanzadas, puedes hacerlo desde la aplicaci√≥n.\n\nEstoy aqu√≠ para ayudarte con cualquier otra cosa que s√≠ tengas disponible.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1328,
        2192
      ],
      "id": "d58fa5bc-1012-4d91-9a70-8b7204ff7ae1",
      "name": "Mensaje1",
      "webhookId": "3d64be0b-b4a4-4044-a71f-50ee53b38bfc",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nombre }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('Procesar Respuesta').item.json.idSeleccionado }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "c1218f27-b9e5-41d4-937e-8bcf4970bb47",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        -3152
      ],
      "id": "4806e84b-5307-4adc-bdf0-3e373c1461f7",
      "name": "Edit Fields67"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe706b3d-bc0d-45dd-99b9-678207a2614f",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "tipo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tipo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7ec47b2b-11c3-415c-9656-415828ff2fc6",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "fecha",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fecha"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a3229ffb-2bfe-430b-b37f-8b7acf1a5278",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nota",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nota"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eae567a1-b5ed-427e-9bac-60d092da4afe",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "estado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "estado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e9842e21-6ce7-42bb-b51a-f95c5b7ac3d7",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "descripcion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "descripcion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8a580cae-03fa-432a-95bf-1cc13cf15851",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nombre",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1840,
        -2480
      ],
      "id": "7777cc91-94d0-486f-8f26-b76f0d841d20",
      "name": "Switch3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "32854c64-2c8b-4783-99f6-56abbf033208",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "d8ea8363-6402-4531-a1dd-d06e84bbc76b",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "d03928ea-324b-4abb-9116-92e8ad292ff7",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "3ec4a0ce-39c8-421d-940b-723dea2f8fd4",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2768
      ],
      "id": "96be91f9-2517-4fb1-a3d8-363c3a611bbc",
      "name": "Edit Fields68"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "c16df9bc-7055-40b4-92fe-196c379aca90",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "42119b8e-2ad2-43e1-b864-00aa4bb6fd8b",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            },
            {
              "id": "c1701a5a-09ec-4b76-a427-8d9337a554d1",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2960
      ],
      "id": "9e680899-9d8b-4143-a339-5489cccbda79",
      "name": "Edit Fields69"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "79327510-d067-4e20-9513-ecd6c8eab69c",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "ca4f2adf-a1c5-41cf-83ea-63368f8c8c81",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "fd8f79a5-8524-4092-bea9-715cbe3a5e6b",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2576
      ],
      "id": "790ffaf9-4f6e-4cce-9c99-f209e7afe925",
      "name": "Edit Fields70"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "a5806382-c736-40c4-a21b-499115143078",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "3c0be6f0-b2d2-4467-8c44-2d5d1c79e1f4",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "f195c2b2-26fd-4c74-87c5-ebfcb481abd7",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2400
      ],
      "id": "4ce6cbee-543f-4db3-b690-2b230c1a4d36",
      "name": "Edit Fields71"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "1a5b8e40-3aeb-4023-8a7a-53483dd95dfc",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "5ab9b498-dddc-4f32-8d6f-a88ec94243de",
              "name": "",
              "value": "",
              "type": "string"
            },
            {
              "id": "678537ff-fa05-4d7b-b816-750d76c0cb4a",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2208
      ],
      "id": "0e811791-9430-49d9-b037-61b73bbaecb3",
      "name": "Edit Fields72"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nombre }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "c1218f27-b9e5-41d4-937e-8bcf4970bb47",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b125274e-96a1-4366-b63a-e0b71c581cc1",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "f83304d8-674b-447c-b2cb-0feab4e27367",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        -2048
      ],
      "id": "eb9c92ef-61b2-41a2-91b2-0f499130e6be",
      "name": "Edit Fields73"
    },
    {
      "parameters": {
        "jsCode": "const entrada = $('WhatsApp Trigger').first().json.messages[0].text.body?.trim().toLowerCase();\n\nconst palabrasCancelar = [\"cancelar\", \"salir\", \"cancel\", \"stop\", \"anular\", \"volver\"];\n\nif (palabrasCancelar.includes(entrada)) {\n  return [\n    {\n      json: {\n        cancelado: true,\n        mensaje: \"Perfecto, he cancelado el proceso. Si quieres iniciar otro, solo d√≠melo.\"\n      }\n    }\n  ];\n}\n\nreturn [\n  {\n    json: {\n      cancelado: false,\n      texto: entrada\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        1136
      ],
      "id": "cb73f2e0-13e1-44b4-955e-5dfe281286d7",
      "name": "Code in JavaScript23"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0ee45fb5-dce3-40c0-8240-01dccfd01c6a",
              "leftValue": "={{ $json.cancelado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -816,
        1136
      ],
      "id": "0731321b-2aa0-4a32-8bec-ea2b06001c4f",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00f02343-9e06-4e09-bb49-55090a1a1209",
              "name": "pendingAction",
              "value": "",
              "type": "string"
            },
            {
              "id": "4a38d4e6-dbf8-43fd-955c-5a7bd5c487a4",
              "name": "pendingData",
              "value": "=",
              "type": "string"
            },
            {
              "id": "47777d4e-572a-4205-bc26-0708619699b1",
              "name": "programaSeleccionado",
              "value": "=",
              "type": "string"
            },
            {
              "id": "eae5d454-556e-43c8-8681-3a5fea7f7def",
              "name": "materiaSeleccionada",
              "value": "=",
              "type": "string"
            },
            {
              "id": "b1536d63-71b9-42c8-b566-2d719b36fcb4",
              "name": "id_Usuario",
              "value": "={{ $('UserContext').first().json.user_Id }}",
              "type": "string"
            },
            {
              "id": "18f30579-8a55-49fb-b64b-f559537e6f84",
              "name": "pendingCamposEvaluacion",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -560,
        1024
      ],
      "id": "ed76da49-04e9-443a-832d-dbb832fbb2bb",
      "name": "Edit Fields36"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "upsert",
        "projectId": "easier-agenda",
        "collection": "usuarios",
        "updateKey": "id_Usuario",
        "columns": "pendingData, pendingAction, programaSeleccionado, materiaSeleccionada, pendingCamposEvaluacion"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -336,
        1024
      ],
      "id": "b4da0878-82d5-4286-8d77-11db506282ff",
      "name": "Actualizar Usuario22",
      "credentials": {
        "googleApi": {
          "id": "NVgNJPDBxDJum3lC",
          "name": "Firebase"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "878662985324581",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
        "textBody": "=Se ha cancelado cualquier proceso que estuviera en proceso. Ahora puedes volver a solicitarme lo que quieras!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -160,
        1024
      ],
      "id": "834d9396-5140-4699-844d-f1e3d45461af",
      "name": "Solicitar Vinculaci√≥n1",
      "webhookId": "fae74b96-47ac-4a2a-832b-f98a98b0df8e",
      "credentials": {
        "whatsAppApi": {
          "id": "O8RPheW7Zq5VrBXE",
          "name": "Whatsapp Account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe706b3d-bc0d-45dd-99b9-678207a2614f",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "tipo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tipo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7ec47b2b-11c3-415c-9656-415828ff2fc6",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "fecha",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fecha"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a3229ffb-2bfe-430b-b37f-8b7acf1a5278",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nota",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nota"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eae567a1-b5ed-427e-9bac-60d092da4afe",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "estado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "estado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e9842e21-6ce7-42bb-b51a-f95c5b7ac3d7",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "descripcion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "descripcion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8a580cae-03fa-432a-95bf-1cc13cf15851",
                    "leftValue": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}",
                    "rightValue": "nombre",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "nombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        6720,
        -288
      ],
      "id": "aa4f2500-70fa-4138-ad99-a71238c2a1b8",
      "name": "Switch4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "32854c64-2c8b-4783-99f6-56abbf033208",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "d8ea8363-6402-4531-a1dd-d06e84bbc76b",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "d03928ea-324b-4abb-9116-92e8ad292ff7",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "3ec4a0ce-39c8-421d-940b-723dea2f8fd4",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -576
      ],
      "id": "4fd3e771-0aaf-491f-b747-226e5fe004c6",
      "name": "Edit Fields74"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "c16df9bc-7055-40b4-92fe-196c379aca90",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "42119b8e-2ad2-43e1-b864-00aa4bb6fd8b",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            },
            {
              "id": "c1701a5a-09ec-4b76-a427-8d9337a554d1",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -768
      ],
      "id": "f7615204-f4c0-4ad6-8709-f44c77fda25e",
      "name": "Edit Fields75"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}  Despu√©s: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "79327510-d067-4e20-9513-ecd6c8eab69c",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "ca4f2adf-a1c5-41cf-83ea-63368f8c8c81",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "fd8f79a5-8524-4092-bea9-715cbe3a5e6b",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -384
      ],
      "id": "944feadb-e532-43f8-a855-12f85c8ad387",
      "name": "Edit Fields76"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "a5806382-c736-40c4-a21b-499115143078",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "3c0be6f0-b2d2-4467-8c44-2d5d1c79e1f4",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "f195c2b2-26fd-4c74-87c5-ebfcb481abd7",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -208
      ],
      "id": "9f7774b8-aa03-4b25-ad6b-17f318882a50",
      "name": "Edit Fields77"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "1a5b8e40-3aeb-4023-8a7a-53483dd95dfc",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nombre }}",
              "type": "string"
            },
            {
              "id": "5ab9b498-dddc-4f32-8d6f-a88ec94243de",
              "name": "",
              "value": "",
              "type": "string"
            },
            {
              "id": "678537ff-fa05-4d7b-b816-750d76c0cb4a",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -16
      ],
      "id": "9fb5a95e-3f19-45c8-a4b0-d8fca3bbed47",
      "name": "Edit Fields78"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9de7c966-f752-4256-9c52-23e46a7e7291",
              "name": "fecha",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.fecha }}",
              "type": "string"
            },
            {
              "id": "93139677-73b3-42a1-8a81-ef030a522473",
              "name": "mensaje",
              "value": "=Antes: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nombre }}  Despu√©s: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.campo_modificado }}: {{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "4f9b9d42-6562-4b7f-8800-ad1da0761393",
              "name": "id_Evaluacion",
              "value": "={{ $('set Evaluaci√≥n ID').item.json.evaluacionSeleccionada }}",
              "type": "string"
            },
            {
              "id": "8160f999-f681-4e97-9fba-72fb277418b7",
              "name": "descripcion",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.descripcion }}",
              "type": "string"
            },
            {
              "id": "ca170e29-8b47-425e-a708-af871fdacacb",
              "name": "estado",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.estado }}",
              "type": "string"
            },
            {
              "id": "b0ffb2a7-9529-41fd-a2da-313b9ea69880",
              "name": "nota",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.nota }}",
              "type": "string"
            },
            {
              "id": "b8d8c50d-d937-4449-b617-2ceaee76b557",
              "name": "tipo",
              "value": "={{ $('Buscar Usuario').first().json.pendingCamposEvaluacion[0].json.tipo }}",
              "type": "string"
            },
            {
              "id": "c1218f27-b9e5-41d4-937e-8bcf4970bb47",
              "name": "nombre",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.pendingCamposEvaluacion[0].json.nuevo_valor }}",
              "type": "string"
            },
            {
              "id": "b125274e-96a1-4366-b63a-e0b71c581cc1",
              "name": "id_Programa",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.programaSeleccionado }}",
              "type": "string"
            },
            {
              "id": "f83304d8-674b-447c-b2cb-0feab4e27367",
              "name": "id_Materia",
              "value": "={{ $('Code in JavaScript22').item.json.usuario.materiaSeleccionada }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        144
      ],
      "id": "36630a89-868d-4f10-bcb2-a4693b3a548c",
      "name": "Edit Fields79"
    }
  ],
  "pinData": {},
  "connections": {
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Interpretador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Buscar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario": {
      "main": [
        [
          {
            "node": "Code in JavaScript22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Agente de respuesta libre",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Agente Interpretador": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente de respuesta libre": {
      "main": [
        [
          {
            "node": "Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Modificar evaluaciones": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar evaluaciones": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "¬øQu√© requiere el usuario?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields10": {
      "main": [
        [
          {
            "node": "Mensaje desconocido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields9": {
      "main": [
        [
          {
            "node": "Agente de respuesta libre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Listar Programa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Edit Fields49",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields39",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields50",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields51",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields52",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UserContext": {
      "main": [
        [
          {
            "node": "Code in JavaScript23",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øTiene pendingAction?": {
      "main": [
        [
          {
            "node": "Switch pendingAction",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agente Interpretador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias": {
      "main": [
        [
          {
            "node": "Procesar Materias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message8": {
      "main": [
        [
          {
            "node": "Edit Fields18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields18": {
      "main": [
        [
          {
            "node": "Actualizar Usuario6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista": {
      "main": [
        [
          {
            "node": "Send message8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Usuario6": {
      "main": [
        []
      ]
    },
    "¬øQu√© requiere el usuario?": {
      "main": [
        [
          {
            "node": "set Fields Agregar Evaluaciones2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set Ver Programas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Listar Programa2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields10",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch pendingAction": {
      "main": [
        [
          {
            "node": "set ChoicePrograma",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set ChoiceEvaluacion",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "set ChoicePrograma1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set ChoicePrograma2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set ChoiceMateria1",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "¬øCoincidencia de Materia?": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener programas": {
      "main": [
        [
          {
            "node": "Procesar Programas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente de Programas": {
      "main": [
        [
          {
            "node": "Mensaje Lista de Programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Ver Programas": {
      "main": [
        [
          {
            "node": "Obtener programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Ver Materias": {
      "main": [
        [
          {
            "node": "Obtener materias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener materias": {
      "main": [
        [
          {
            "node": "Code in JavaScript19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Programa2": {
      "main": [
        [
          {
            "node": "Procesar Programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øUn √∫nico programa?": {
      "main": [
        [
          {
            "node": "set ProgramaID Directo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Lista de Programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Programas": {
      "main": [
        [
          {
            "node": "¬øUn √∫nico programa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ProgramaID Directo": {
      "main": [
        [
          {
            "node": "set Ver Materias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Lista de Programas": {
      "main": [
        [
          {
            "node": "Mensaje Selecci√≥n de Programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Selecci√≥n de Programas": {
      "main": [
        [
          {
            "node": "set pendingAction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set pendingAction": {
      "main": [
        [
          {
            "node": "Actualizar Usuario9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Agente de Materias1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Obtener materias1": {
      "main": [
        [
          {
            "node": "set Lista Materias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Lista Materias1": {
      "main": [
        [
          {
            "node": "Agente de Materias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente de Materias1": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Actualizar Usuario2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Usuario2": {
      "main": [
        [
          {
            "node": "Msj Lista Materias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs un programa v√°lido?1": {
      "main": [
        [
          {
            "node": "Seleccionar Programa1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ChoicePrograma1": {
      "main": [
        [
          {
            "node": "¬øEs un programa v√°lido?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar Programa1": {
      "main": [
        [
          {
            "node": "set Programa ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Usuario3": {
      "main": [
        [
          {
            "node": "Obtener materias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Programa ID1": {
      "main": [
        [
          {
            "node": "Actualizar Usuario3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Programas2": {
      "main": [
        [
          {
            "node": "Agente de Programas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Agente de Programas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Listar Programa3": {
      "main": [
        [
          {
            "node": "Procesar Programas3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øUn √∫nico programa?2": {
      "main": [
        [
          {
            "node": "set ProgramaID Directo2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Programas3": {
      "main": [
        [
          {
            "node": "¬øUn √∫nico programa?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Lista de Programas1": {
      "main": [
        [
          {
            "node": "Mensaje Selecci√≥n de Programas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Selecci√≥n de Programas1": {
      "main": [
        [
          {
            "node": "Edit Fields7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ProgramaID Directo2": {
      "main": [
        [
          {
            "node": "Listar Materias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs un programa v√°lido?2": {
      "main": [
        [
          {
            "node": "Seleccionar Programa2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ChoicePrograma2": {
      "main": [
        [
          {
            "node": "¬øEs un programa v√°lido?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar Programa2": {
      "main": [
        [
          {
            "node": "set Programa ID2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Edit Fields8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "¬øCoincide el programa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias1": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "set Fields Agregar Evaluaciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar evaluaciones1": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias1": {
      "main": [
        [
          {
            "node": "Procesar Materias2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Actualizar Usuario7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista1": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincidencia de Materia?1": {
      "main": [
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent2": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias2": {
      "main": [
        [
          {
            "node": "AI Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript6": {
      "main": [
        [
          {
            "node": "Guardar materia seleccionada1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar materia seleccionada1": {
      "main": [
        [
          {
            "node": "Agregar evaluaciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields8": {
      "main": [
        [
          {
            "node": "Listar Materias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Materia ID1": {
      "main": [
        [
          {
            "node": "Crear Evaluaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ChoiceMateria1": {
      "main": [
        [
          {
            "node": "¬øEs una materia v√°lida?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs una materia v√°lida?1": {
      "main": [
        [
          {
            "node": "Seleccionar Materia1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar Materia1": {
      "main": [
        [
          {
            "node": "set Materia ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Evaluaci√≥n": {
      "main": [
        [
          {
            "node": "Send message11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message11": {
      "main": [
        [
          {
            "node": "Edit Fields17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields17": {
      "main": [
        [
          {
            "node": "Actualizar Usuario5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Evaluaci√≥n1": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Programa ID2": {
      "main": [
        [
          {
            "node": "Listar Materias2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincide el programa?": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Lista de Programas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields7": {
      "main": [
        [
          {
            "node": "Actualizar Usuario10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias2": {
      "main": [
        [
          {
            "node": "Procesar Materias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message13": {
      "main": [
        [
          {
            "node": "Edit Fields20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields20": {
      "main": [
        [
          {
            "node": "Actualizar Usuario12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista3": {
      "main": [
        [
          {
            "node": "Send message13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincidencia de Materia?2": {
      "main": [
        [
          {
            "node": "Code in JavaScript8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent3": {
      "main": [
        [
          {
            "node": "Code in JavaScript7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript7": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model9": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias": {
      "main": [
        [
          {
            "node": "AI Agent3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript8": {
      "main": [
        [
          {
            "node": "Guardar materia seleccionada2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar materia seleccionada2": {
      "main": [
        [
          {
            "node": "Crear Evaluaci√≥n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields21": {
      "main": [
        [
          {
            "node": "Actualizar Usuario13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n3": {
      "main": [
        [
          {
            "node": "Edit Fields21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias3": {
      "main": [
        [
          {
            "node": "Procesar Materias3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincidencia de Materia?3": {
      "main": [
        [
          {
            "node": "Code in JavaScript12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Programa": {
      "main": [
        [
          {
            "node": "Procesar Programas4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ProgramaID Directo4": {
      "main": [
        [
          {
            "node": "Listar Materias3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øUn √∫nico programa?3": {
      "main": [
        [
          {
            "node": "set ProgramaID Directo4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Programas4": {
      "main": [
        [
          {
            "node": "¬øUn √∫nico programa?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Lista de Programas2": {
      "main": [
        [
          {
            "node": "Mensaje Selecci√≥n de Programas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Selecci√≥n de Programas2": {
      "main": [
        [
          {
            "node": "Edit Fields24",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent4": {
      "main": [
        [
          {
            "node": "Code in JavaScript10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model10": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript9": {
      "main": [
        [
          {
            "node": "Edit Fields22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields22": {
      "main": [
        [
          {
            "node": "Listar Materias4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript10": {
      "main": [
        [
          {
            "node": "¬øCoincide el programa?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent5": {
      "main": [
        [
          {
            "node": "Code in JavaScript11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript11": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model11": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent5",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias3": {
      "main": [
        [
          {
            "node": "AI Agent5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript12": {
      "main": [
        [
          {
            "node": "Guardar materia seleccionada3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar materia seleccionada3": {
      "main": [
        [
          {
            "node": "Obtener evaluaciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar evaluaciones3": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias4": {
      "main": [
        [
          {
            "node": "Procesar Materias4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message14": {
      "main": [
        [
          {
            "node": "Edit Fields23",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields23": {
      "main": [
        [
          {
            "node": "Actualizar Usuario15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista5": {
      "main": [
        [
          {
            "node": "Send message14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincidencia de Materia?4": {
      "main": [
        [
          {
            "node": "Code in JavaScript14",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent6": {
      "main": [
        [
          {
            "node": "Code in JavaScript13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript13": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model12": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent6",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias4": {
      "main": [
        [
          {
            "node": "AI Agent6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript14": {
      "main": [
        [
          {
            "node": "Guardar materia seleccionada4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar materia seleccionada4": {
      "main": [
        [
          {
            "node": "Agregar evaluaciones3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincide el programa?1": {
      "main": [
        [
          {
            "node": "Code in JavaScript9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Lista de Programas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields24": {
      "main": [
        [
          {
            "node": "Actualizar Usuario14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs un programa v√°lido?": {
      "main": [
        [
          {
            "node": "Seleccionar Programa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ChoicePrograma": {
      "main": [
        [
          {
            "node": "¬øEs un programa v√°lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar Programa": {
      "main": [
        [
          {
            "node": "set Programa ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Programa ID": {
      "main": [
        [
          {
            "node": "Listar Materias5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n4": {
      "main": [
        [
          {
            "node": "Edit Fields26",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Materias5": {
      "main": [
        [
          {
            "node": "Procesar Materias5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message16": {
      "main": [
        [
          {
            "node": "Edit Fields25",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields25": {
      "main": [
        [
          {
            "node": "Actualizar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista6": {
      "main": [
        [
          {
            "node": "Send message16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCoincidencia de Materia?5": {
      "main": [
        [
          {
            "node": "Code in JavaScript16",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar la lista6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent7": {
      "main": [
        [
          {
            "node": "Code in JavaScript15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript15": {
      "main": [
        [
          {
            "node": "¬øCoincidencia de Materia?5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model13": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent7",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Materias5": {
      "main": [
        [
          {
            "node": "AI Agent7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript16": {
      "main": [
        [
          {
            "node": "Guardar materia seleccionada5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar materia seleccionada5": {
      "main": [
        [
          {
            "node": "Obtener evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields26": {
      "main": [
        [
          {
            "node": "Actualizar Usuario16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent8": {
      "main": [
        [
          {
            "node": "Procesar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent8",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Obtener evaluaciones": {
      "main": [
        [
          {
            "node": "Procesar lista de evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Modificar": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar lista de evaluaciones": {
      "main": [
        [
          {
            "node": "Code in JavaScript18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta": {
      "main": [
        [
          {
            "node": "Coincidencia de evaluaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Edit Fields45",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields38",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields46",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields47",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields48",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields67",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript17": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields33": {
      "main": [
        [
          {
            "node": "Actualizar Usuario17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n6": {
      "main": [
        [
          {
            "node": "Edit Fields33",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript18": {
      "main": [
        [
          {
            "node": "AI Agent8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set ChoiceEvaluacion": {
      "main": [
        [
          {
            "node": "¬øEs una evaluaci√≥n v√°lida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs una evaluaci√≥n v√°lida?": {
      "main": [
        [
          {
            "node": "Seleccionar Evaluaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar Evaluaci√≥n": {
      "main": [
        [
          {
            "node": "set Evaluaci√≥n ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n7": {
      "main": [
        [
          {
            "node": "Edit Fields34",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields34": {
      "main": [
        [
          {
            "node": "Actualizar Usuario18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Modificar1": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Evaluaci√≥n ID": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields45": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields38": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields46": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields47": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields48": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields49": {
      "main": [
        [
          {
            "node": "Modificar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields39": {
      "main": [
        [
          {
            "node": "Modificar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields50": {
      "main": [
        [
          {
            "node": "Modificar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields51": {
      "main": [
        [
          {
            "node": "Modificar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields52": {
      "main": [
        [
          {
            "node": "Modificar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coincidencia de evaluaci√≥n": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Fields Agregar Evaluaciones1": {
      "main": [
        [
          {
            "node": "Agregar evaluaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set Fields Agregar Evaluaciones2": {
      "main": [
        [
          {
            "node": "Listar Programa3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n8": {
      "main": [
        [
          {
            "node": "Edit Fields29",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message18": {
      "main": [
        [
          {
            "node": "Edit Fields28",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields28": {
      "main": [
        [
          {
            "node": "Actualizar Usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar la lista7": {
      "main": [
        [
          {
            "node": "Send message18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields29": {
      "main": [
        [
          {
            "node": "Actualizar Usuario20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent9": {
      "main": [
        [
          {
            "node": "Procesar Respuesta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model14": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent9",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Obtener evaluaciones1": {
      "main": [
        [
          {
            "node": "Procesar lista de evaluaciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar lista de evaluaciones1": {
      "main": [
        [
          {
            "node": "Code in JavaScript21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta1": {
      "main": [
        [
          {
            "node": "Coincidencia de evaluaci√≥n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript20": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmaci√≥n adici√≥n9": {
      "main": [
        [
          {
            "node": "Edit Fields35",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields35": {
      "main": [
        [
          {
            "node": "Actualizar Usuario21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript21": {
      "main": [
        [
          {
            "node": "AI Agent9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coincidencia de evaluaci√≥n1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript19": {
      "main": [
        [
          {
            "node": "Confirmaci√≥n adici√≥n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript22": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "UserContext",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Solicitar Vinculaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields11": {
      "main": [
        [
          {
            "node": "Mensaje desconocido1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields67": {
      "main": [
        [
          {
            "node": "Modificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Edit Fields69",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields68",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields70",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields71",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields72",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields73",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields73": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields72": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields71": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields70": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields68": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields69": {
      "main": [
        [
          {
            "node": "Modificar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript23": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Edit Fields36",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øTiene pendingAction?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields36": {
      "main": [
        [
          {
            "node": "Actualizar Usuario22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Usuario22": {
      "main": [
        [
          {
            "node": "Solicitar Vinculaci√≥n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "Edit Fields75",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields74",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields76",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields77",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields78",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields79",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "7a59d78e-2890-413f-ab54-fb344cac9d0f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f3096e211ab8d8209d08ebc9d31dba42ed55f4faba91f6c75ad33cdd2d7572f2"
  },
  "id": "k259pDCEgGsOHlzj",
  "tags": []
}